
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>măm</title>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <!-- Google Fonts: Rowdies & Montserrat (from Code 1) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Rowdies:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- GLOBAL STYLES & SETUP (MERGED & ENHANCED) --- */
        :root {
            --primary-color: #e16232;
            --bg-color: #f8f1d5;
            --dark-text: #000000;
            --light-text: #f8f1d5;
            --green: #4f823d;
            --blue: #4a83b8;
            --yellow: #fae961;
            --title-font: 'Rowdies', 'Helvetica Neue', sans-serif;
            --body-font: 'Montserrat', 'Helvetica Neue', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            font-family: var(--body-font);
            margin: 0;
            overflow-x: hidden;
            scroll-behavior: smooth;
            color: #333;
        }

        h1, h2, h3 {
             font-family: var(--title-font);
             color: var(--primary-color);
        }

        .hidden {
            display: none !important;
        }

        /* --- FADE-IN ANIMATION --- */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .logo-fade-in {
            animation: fadeIn 2s ease-in-out;
        }
        
        /* --- LANGUAGE SELECTOR (SHARED) --- */
        .language-selector { background: rgba(255, 255, 255, 0.2); padding: 5px 10px; border-radius: 10px; }
        .lang-btn { color: var(--dark-text); text-decoration: none; font-weight: bold; margin: 0 5px; cursor: pointer; transition: color 0.3s; }
        .lang-btn.active { color: var(--primary-color); }

        /* --- PAGE 1: WELCOME (from Code 1) --- */
        #page1 { display: flex; justify-content: center; align-items: center; height: 100vh; text-align: center; position: relative; overflow: hidden; }
        .welcome-container { z-index: 5; position: relative; }
        #page1 .language-selector { position: absolute; top: -70px; right: 0; }
        
        .slogan { font-family: var(--body-font); color: var(--dark-text); font-size: 1.5rem; margin-top: 20px; font-weight: 700; height: 2.5em; }
        
        .slogan .cursor { display: inline-block; background-color: var(--dark-text); margin-left: 0.1rem; width: 3px; animation: blink 1s infinite; }
        @keyframes blink { 50% { background-color: transparent; } }
        .start-button { font-family: var(--title-font); display: inline-block; margin-top: 40px; padding: 15px 45px; border: 3px solid var(--primary-color); border-radius: 50px; color: var(--primary-color); text-decoration: none; font-weight: normal; font-size: 1.5rem; transition: background-color 0.3s, color 0.3s; }
        .start-button:hover { background-color: var(--primary-color); color: var(--light-text); cursor: pointer; }
        .decorations { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        .decorations .shape { position: absolute; animation: float 25s infinite linear; list-style: none; }
        .decorations .circle { width: 30px; height: 30px; background-color: var(--green); border-radius: 50%; top: 10%; left: 15%; animation-duration: 22s; }
        .decorations .star { width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-bottom: 30px solid var(--blue); top: 80%; left: 10%; animation-delay: -5s; animation-duration: 28s; }
        .decorations .heart { position: relative; width: 30px; height: 27px; top: 50%; left: 90%; animation-delay: -10s; animation-duration: 19s; }
        .decorations .heart:before, .decorations .heart:after { content: ""; position: absolute; top: 0; width: 15px; height: 24px; background-color: var(--primary-color); border-radius: 15px 15px 0 0; }
        .decorations .heart:before { left: 15px; transform: rotate(-45deg); transform-origin: 0 100%; }
        .decorations .heart:after { left: 0; transform: rotate(45deg); transform-origin: 100% 100%; }
        .decorations .triangle { width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-bottom: 30px solid var(--yellow); top: 20%; left: 85%; animation-delay: -15s; animation-duration: 30s; }
        .decorations .circle.c2 { top: 75%; left: 80%; background-color: var(--yellow); animation-delay: -3s; animation-duration: 24s; }
        .decorations .triangle.t2 { top: 40%; left: 5%; border-bottom-color: var(--green); animation-delay: -8s; animation-duration: 20s; }
        @keyframes float { 0% { transform: translateY(0px) rotate(0deg); opacity: 0.7; } 50% { transform: translateY(-30px) rotate(180deg); opacity: 1; } 100% { translateY(0px) rotate(360deg); opacity: 0.7; } }
        
        /* --- PAGE 2: HOME CAROUSEL (from Code 1) --- */
        #page2 { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        .carousel-container { display: flex; align-items: center; justify-content: center; width: 100%; height: 350px; }
        .carousel { position: relative; width: 100%; height: 100%; }
        .carousel-item { position: absolute; width: 220px; height: auto; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; text-align: center; cursor: pointer; transition: transform 0.5s ease-out, opacity 0.5s ease-out; left: 50%; top: 50%; margin-left: -110px; margin-top: -150px; transform: scale(0); opacity: 0; background: none; }
        .image-wrapper { position: relative; width: 200px; height: 200px; display: flex; justify-content: center; align-items: center; margin-bottom: 20px; transition: transform 0.3s; }
        .carousel-item:hover .image-wrapper { transform: translateY(-5px); }
        .carousel-item .carousel-image { max-width: 100%; max-height: 100%; width: auto; height: auto; object-fit: contain; }
        
        .carousel-item .circle-content { font-family: var(--title-font); font-size: 1.7rem; color: var(--dark-text); font-weight: bold; }
        
        .carousel-item.active { transform: translateX(0) scale(1.5); opacity: 1; z-index: 10; }
        .carousel-item.prev { transform: translateX(-280px) scale(0.8); opacity: 0.5; z-index: 5; }
        .carousel-item.next { transform: translateX(280px) scale(0.8); opacity: 0.5; z-index: 5; }
        
        .discovery-follower { font-family: var(--title-font); position: absolute; width: 50px; height: 50px; background-color: var(--dark-text); border-radius: 50%; color: var(--light-text); display: flex; justify-content: center; align-items: center; font-size: 0.6rem; font-weight: normal; opacity: 0; transform: translate(-50%, -50%) scale(0); transition: opacity 0.3s, transform 0.3s; pointer-events: none; z-index: 11; line-height: 1; }
        .carousel-item.active .image-wrapper:hover .discovery-follower { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        .carousel-nav { margin-top: 50px; }
        
        .carousel-nav button { background-color: var(--primary-color); border: none; color: white; padding: 0; line-height: 50px; text-align: center; font-size: 24px; cursor: pointer; margin: 0 25px; border-radius: 50%; width: 50px; height: 50px; transition: transform 0.2s; }
        .carousel-nav button:hover { transform: scale(1.1); }

        /* --- SHARED HEADER & FOOTER (MERGED) --- */
        .main-header { position: fixed; top: 0; width: 100%; background-color: rgba(255, 255, 255, 0.5); backdrop-filter: blur(5px); z-index: 1000; transition: top 0.4s ease-in-out; }
        .main-nav { display: flex; justify-content: space-between; align-items: center; padding: 10px 30px; }
        .nav-left, .nav-right { display: flex; align-items: center; gap: 15px; }
        
        .nav-item { font-family: var(--title-font); font-size: 1.2rem; color: #333; text-decoration: none; padding: 8px 15px; margin: 0; border-radius: 8px; font-weight: bold; transition: background-color 0.3s, color 0.3s; }
        
        .nav-item:hover { background-color: rgba(225, 98, 50, 0.2); }
        .nav-item.active { background-color: var(--primary-color); color: var(--light-text); }
        
        .nav-logo img { height: 30px; width: auto; }
        
        .contact-footer h3 { font-size: 2rem; font-weight: normal; }

        /* NEW: User Profile Styles (from Code 2) */
        .user-profile { display: flex; align-items: center; gap: 12px; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-color); }
        .user-name { font-weight: bold; color: #333; font-family: var(--body-font); font-size: 1rem; }
        #logout-btn { color: #333; cursor: pointer; font-family: var(--title-font); font-size: 1.2rem; text-decoration: none; padding: 8px 15px; border-radius: 8px; transition: background-color 0.3s, color 0.3s; }
        #logout-btn:hover { background-color: rgba(225, 98, 50, 0.2); }

        /* --- CONTENT PAGES & ABOUT PAGE (from Code 1) --- */
        .page-content { padding-top: 100px; padding-bottom: 100px; min-height: 100vh; }
        .page-content p { font-family: var(--body-font); }
        
        .about-section .slogan-sub { font-family: var(--body-font); font-size: 1.3rem; color: #333; font-weight: 700; }
        
        .photo-frame-section { position: relative; width: 100%; margin: 8rem 0; display: flex; justify-content: center; align-items: center; }
        .about-video { max-width: 100%; height: auto; display: block; border-radius: 15px; }
        .text-overlay { position: absolute; z-index: 2; background-color: rgba(255, 255, 255, 0.7); backdrop-filter: blur(5px); padding: 30px; width: 80%; max-width: 800px; border-radius: 15px; font-size: 1.1rem; color: #000; line-height: 1.6; text-align: center; }
        
        .decorative-line-section { width: 100vw; position: relative; left: 50%; transform: translateX(-50%); padding: 80px 0 40px 0; }
        .decorative-line-section img { width: 100%; height: auto; display: block; }
        
        .about-section.final-text { padding-top: 0; padding-bottom: 80px; }
        
        .final-text p { font-size: 1.1rem; line-height: 1.7; font-weight: 600; }
        
        .feature-section h2 { font-size: 2.8rem; font-weight: bold; }
        
        .feature-section p { line-height: 1.6; margin-bottom: 30px; }
        .more-button { font-family: var(--title-font); font-size: 1.2rem; display: inline-block; padding: 10px 30px; border: 2px solid var(--primary-color); border-radius: 30px; color: var(--primary-color); text-decoration: none; font-weight: normal; transition: background-color 0.3s, color 0.3s; }
        .more-button:hover { background-color: var(--primary-color); color: var(--light-text); }
        
        .feature-section { display: flex; gap: 40px; align-items: center; padding: 50px 10%; }

        /* --- DYNAMIC CONTENT STYLES (from Code 2, adapted) --- */
        .content-container { padding: 20px 5%; max-width: 1200px; margin: 0 auto; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; text-align: center; flex-direction: column;}
        .page-header h1 { font-family: var(--title-font); font-size: 3.5rem; font-weight: normal; margin-bottom: 20px; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 30px; }
        .item-box { background-color: white; border: 1px solid #ddd; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.05); display: flex; flex-direction: column; transition: transform 0.2s, box-shadow 0.2s; }
        .item-box:hover { transform: translateY(-5px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
        .item-image { width: 100%; height: 250px; background-size: cover; background-position: center; }
        .item-info { padding: 15px; text-align: left; flex-grow: 1; display: flex; flex-direction: column; }
        .item-name { font-size: 1.2rem; margin: 0 0 10px 0; color: #333; font-family: var(--title-font); }
        .item-price { font-size: 1.1rem; color: var(--primary-color); font-weight: bold; margin-bottom: 15px; }
        .item-details { font-size: 0.9rem; color: #666; margin-bottom: 15px; }
        .item-details span { display: block; margin-bottom: 5px; font-family: var(--body-font); }
        .item-actions { margin-top: auto; display: flex; gap: 10px; }
        .action-btn { width: 100%; padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: opacity 0.3s; font-family: var(--body-font);}
        .contact-owner-btn { background-color: var(--green); color: var(--light-text); }
        .add-to-cart-btn { background-color: var(--primary-color); color: var(--light-text); }
        .action-btn:hover { opacity: 0.9; }
        .placeholder-page { display: flex; justify-content: center; align-items: center; flex-direction: column; min-height: 60vh; padding: 20px; }
        .placeholder-page p { color: #333; font-size: 1.2rem;}

        /* --- LOGIN & REGISTER FORM STYLES (from Code 1, adapted for Code 2 structure) --- */
        #page8 { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 40px 20px; }
        .form-wrapper { background-color: #fff; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 450px; text-align: center; position: relative; }
        .form-wrapper h2 { font-family: var(--title-font); font-size: 2.2rem; font-weight: normal; margin-bottom: 20px;}
        .close-form-btn { position: absolute; top: 15px; right: 20px; font-size: 2rem; color: #aaa; cursor: pointer; transition: color 0.3s; text-decoration: none; }
        .close-form-btn:hover { color: var(--dark-text); }
        .form-toggle { display: flex; justify-content: center; margin-bottom: 30px; border: 1px solid #ddd; border-radius: 30px; overflow: hidden; }
        .form-toggle button { flex: 1; padding: 15px; border: none; background-color: transparent; cursor: pointer; transition: all 0.3s; color: #333; font-family: var(--body-font); font-weight: bold; font-size: 1rem; }
        .form-toggle button.active { background-color: var(--primary-color); color: white; }
        .social-login .social-btn { padding: 12px; margin-bottom: 10px; border-radius: 8px; text-decoration: none; font-weight: bold; color: #fff; display: flex; align-items: center; justify-content: center; gap: 10px; transition: opacity 0.3s; border: none; cursor: pointer; width: 100%; font-family: var(--body-font); }
        .social-login .social-btn:hover { opacity: 0.9; }
        .social-btn i { font-size: 1.2rem; }
        .social-btn.facebook { background-color: #3b5998; }
        .social-btn.google { background-color: #db4437; }
        .divider { display: flex; align-items: center; text-align: center; margin: 25px 0; color: #aaa; }
        .divider::before, .divider::after { content: ''; flex: 1; border-bottom: 1px solid #ddd; }
        .divider p { margin: 0 15px; font-weight: bold; }
        .form-wrapper form input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .submit-btn { font-family: var(--body-font); font-weight: bold; font-size: 1.1rem; width: 100%; padding: 15px; border: none; background-color: var(--primary-color); color: white; border-radius: 8px; cursor: pointer; transition: opacity 0.3s;}
        .submit-btn:hover { opacity: 0.9; }

        .contact-footer { background-color: var(--dark-text); color: var(--light-text); padding: 40px 10%; text-align: center; }
        .contact-info { display: flex; justify-content: center; align-items: center; gap: 30px; flex-wrap: wrap; }
        .contact-info a, .contact-info span { color: var(--light-text); text-decoration: none; font-size: 1.1rem; }
        .contact-info svg { width: 30px; height: 30px; fill: var(--light-text); transition: fill 0.3s; }
        .contact-info a:hover svg { fill: var(--primary-color); }
        .about-section { padding: 50px 10%; text-align: center; margin-bottom: 0; }
        .about-section .logo-main img { height: 8rem; width: auto; }
        .about-decorations { position: relative; height: 100px; margin-bottom: 3rem; }
        .scroll-banner { background-color: var(--primary-color); color: var(--light-text); overflow: hidden; white-space: nowrap; padding: 20px 0; border-top: 3px solid black; border-bottom: 3px solid black; display: flex; }
        .scroll-text { display: flex; animation: scroll-left 40s linear infinite; }
        .scroll-text span { white-space: nowrap; padding-right: 2em; font-size: 1.2rem; }
        @keyframes scroll-left { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        .final-text p { max-width: 800px; margin: 0 auto; }
        .feature-section:nth-child(even) { flex-direction: row-reverse; }
        .feature-text { flex: 1; text-align: left; }

        .feature-image { flex: 1; height: 300px; display: flex; align-items: center; justify-content: center; background-size: contain; background-position: center; background-repeat: no-repeat; animation: float-vertical 3s ease-in-out infinite alternate; }
        @keyframes float-vertical { from { transform: translateY(-20px); } to { transform: translateY(20px); } }

        #feature-sections-container { margin-bottom: 80px; }
        #feature-sections-container .feature-section:nth-child(1) .feature-image { background-image: url('knsm.png'); }
        #feature-sections-container .feature-section:nth-child(2) .feature-image { background-image: url('t&p.png'); }
        #feature-sections-container .feature-section:nth-child(3) .feature-image { background-image: url('cnlcm.png'); }
        
        @media (max-width: 768px) { .feature-section, .feature-section:nth-child(even) { flex-direction: column; } }

        .post-item-btn { position: fixed; bottom: 110px; right: 40px; width: 70px; height: 70px; background-color: var(--primary-color); color: var(--light-text); border: none; border-radius: 35px; font-size: 28px; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer; z-index: 1001; transition: transform 0.2s; }
        .post-item-btn:hover { transform: scale(1.1); }
        
        /* CHAT WIDGET STYLES (from Code 1) */
        #floating-chat-widget { position: fixed; bottom: 30px; right: 30px; z-index: 2000; }
        #chat-toggle-btn { background-color: var(--primary-color); color: var(--light-text); width: 60px; height: 60px; border-radius: 50%; border: none; font-size: 28px; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.25); cursor: pointer; transition: transform 0.2s ease-out; }
        #chat-toggle-btn:hover { transform: scale(1.1); }
        #chat-window { position: absolute; bottom: 80px; right: 0; width: 370px; height: 500px; background: white; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.2); display: flex; flex-direction: column; overflow: hidden; transform-origin: bottom right; transform: scale(0); opacity: 0; transition: transform 0.3s ease-out, opacity 0.3s ease-out; }
        #chat-window.visible { transform: scale(1); opacity: 1; }
        .chat-header { position: relative; padding: 15px; background-color: var(--primary-color); color: var(--light-text); font-weight: bold; font-size: 1.1rem; text-align: center; font-family: var(--title-font); }
        .chat-close-btn { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); background: none; border: none; color: var(--light-text); font-size: 2rem; line-height: 1; cursor: pointer; opacity: 0.8; }
        .chat-close-btn:hover { opacity: 1; }
        .chat-messages { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .message { padding: 10px 15px; border-radius: 18px; max-width: 85%; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word; }
        .user-message { background-color: #e0e0e0; color: black; align-self: flex-end; border-bottom-right-radius: 4px; }
        .ai-message { background-color: var(--blue); color: white; align-self: flex-start; border-bottom-left-radius: 4px; }
        .chat-input-area { display: flex; padding: 10px; border-top: 1px solid #ddd; background: #f9f9f9; }
        .chat-input-area #chat-text-input { flex-grow: 1; border: 1px solid #ccc; border-radius: 20px; padding: 10px 15px; resize: none; margin: 0 10px; font-family: var(--body-font); }
        .chat-input-area button { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #555; transition: color 0.3s; padding: 5px; }
        .chat-input-area button:hover { color: var(--primary-color); }
        .image-upload-label { display: flex; align-items: center; justify-content: center; }
        @media (max-width: 480px) { #chat-window { width: calc(100vw - 40px); height: 70vh; right: -10px; bottom: 80px; } }
        
        /* MODAL STYLES (MERGED) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 3000; display: flex; justify-content: center; align-items: center; padding: 20px; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); width: 100%; max-width: 600px; position: relative; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        .modal-header h2 { font-family: var(--title-font); font-size: 2.2rem; font-weight: normal; margin: 0; }
        .modal-close-btn { font-size: 2.5rem; line-height: 1; color: #aaa; cursor: pointer; background: none; border: none; }
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 5px; color: #333; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-family: inherit; font-size: 1rem; }

        /* ======== CART STYLES ======== */
        .header-cart-icon {
            position: relative;
            cursor: pointer;
            color: var(--primary-color);
            font-size: 1.8rem;
        }
        .cart-badge {
            position: absolute;
            top: -5px;
            right: -10px;
            background-color: var(--dark-text);
            color: var(--light-text);
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 0.8rem;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: var(--body-font);
            font-weight: bold;
        }
        #cart-page-container {
            display: flex;
            gap: 30px;
            padding: 20px 5%;
        }
        #cart-items-section { flex: 2; }
        #delivery-info-section { flex: 1; background-color: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        .cart-item {
            display: flex;
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            gap: 15px;
            align-items: center;
        }
        .cart-item-img { width: 80px; height: 80px; object-fit: cover; border-radius: 5px; }
        .cart-item-info { flex-grow: 1; }
        .cart-item-info h4 { margin: 0 0 10px 0; font-family: var(--title-font); color: #333;}
        .cart-item-info p { margin: 0; color: #666; font-size: 0.9rem; }
        .cart-item-remove-btn { color: #aaa; cursor: pointer; font-size: 1.2rem; }
        .cart-item-remove-btn:hover { color: red; }

        @media (max-width: 992px) {
            #cart-page-container { flex-direction: column; }
        }

        /* ======== NEW: HANDBOOK PAGE (#page6) STYLES ======== */
        .handbook-choice-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
        }
        .handbook-choice-btn {
            font-family: var(--title-font);
            font-size: 1.3rem;
            padding: 15px 30px;
            border: 2px solid var(--primary-color);
            border-radius: 30px;
            color: var(--primary-color);
            background-color: transparent;
            cursor: pointer;
            transition: all 0.3s;
        }
        .handbook-choice-btn:hover {
            background-color: rgba(225, 98, 50, 0.2);
        }
        .handbook-choice-btn.active {
            background-color: var(--primary-color);
            color: var(--light-text);
        }
        .handbook-form-container {
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            max-width: 700px;
            margin: 0 auto;
        }
        #handbook-result-container {
            margin-top: 40px;
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            white-space: pre-wrap; /* To respect newlines from AI */
            line-height: 1.7;
            font-family: var(--body-font);
            text-align: left;
        }
         #handbook-result-container h3 {
            font-size: 1.8rem;
            text-align: center;
            margin-top: 0;
        }
        #handbook-result-container ul {
            padding-left: 20px;
            list-style: none;
        }
         #handbook-result-container li {
             margin-bottom: 10px;
         }
        #handbook-result-container strong {
            font-family: var(--title-font);
            color: var(--primary-color);
            font-weight: normal;
        }
        .loading-spinner {
            display: block;
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body>

    <!-- ======== Page 1: Welcome (from Code 1) ======== -->
    <div id="page1">
        <div class="welcome-container">
            <div class="language-selector"><a class="lang-btn" data-lang="en">EN</a> | <a class="lang-btn active" data-lang="vi">VI</a></div>
            <div class="logo-main">
                <img src="logo.png" alt="măm logo" class="logo-fade-in" style="width: 50vw; max-width: 450px; height: auto;">
            </div>
            <p class="slogan" data-lang-key="slogan"></p>
            <a id="startButton" class="start-button" data-lang-key="start"></a>
        </div>
        <div class="decorations"> <div class="shape circle"></div><div class="shape star"></div><div class="shape heart"></div><div class="shape triangle"></div><div class="shape circle c2"></div><div class="shape triangle t2"></div> </div>
    </div>

    <!-- ======== Page 2: Carousel (from Code 1) ======== -->
    <div id="page2" class="hidden">
        <div class="carousel-container">
            <div class="carousel">
                <div class="carousel-item" data-target="page3">
                    <div class="image-wrapper"><img src="vct.png" alt="Về chúng tôi" class="carousel-image"><div class="discovery-follower" data-lang-key="explore"></div></div>
                    <div class="circle-content" data-lang-key="about"></div>
                </div>
                <div class="carousel-item" data-target="page4">
                    <div class="image-wrapper"><img src="knsm.png" alt="Kết nối sữa mẹ" class="carousel-image"><div class="discovery-follower" data-lang-key="explore"></div></div>
                    <div class="circle-content" data-lang-key="connect"></div>
                </div>
                <div class="carousel-item" data-target="page5">
                    <div class="image-wrapper"><img src="t&p.png" alt="Thuê - Pass đồ" class="carousel-image"><div class="discovery-follower" data-lang-key="explore"></div></div>
                    <div class="circle-content" data-lang-key="rent"></div>
                </div>
                <div class="carousel-item" data-target="page6">
                    <div class="image-wrapper"><img src="cnlcm.png" alt="Cẩm nang làm cha mẹ" class="carousel-image"><div class="discovery-follower" data-lang-key="explore"></div></div>
                    <div class="circle-content" data-lang-key="handbook"></div>
                </div>
            </div>
        </div>
        <div class="carousel-nav"><button id="prevBtn"><</button><button id="nextBtn">></button></div>
    </div>

    <!-- ======== Header (MERGED) ======== -->
    <header id="mainHeader" class="main-header hidden">
        <nav class="main-nav">
            <div class="nav-left">
                <a href="#" class="nav-logo" data-target="page1"><img src="logo.png" alt="măm logo"></a>
                <a href="#" class="nav-item" data-target="page3" data-lang-key="about"></a>
                <a href="#" class="nav-item" data-target="page4" data-lang-key="connect"></a>
                <a href="#" class="nav-item" data-target="page5" data-lang-key="rent"></a>
                <a href="#" class="nav-item" data-target="page6" data-lang-key="handbook"></a>
            </div>
            <div class="nav-right">
                 <!-- Auth links from Code 2, styled by Code 1 -->
                <div id="auth-links">
                    <a href="#" class="nav-item" data-target="page8" data-action="show-login" data-lang-key="login"></a>
                    <a href="#" class="nav-item" data-target="page8" data-action="show-register" data-lang-key="register"></a>
                </div>
                <!-- User profile from Code 2, styled by merged CSS -->
                <div id="user-profile" class="user-profile hidden">
                    <img id="user-avatar" src="" alt="Avatar" class="user-avatar">
                    <span id="user-name" class="user-name"></span>
                    <a href="#" id="logout-btn" data-lang-key="logout"></a>
                </div>
                <!-- NEW: Cart Icons -->
                <div id="product-cart-icon" class="header-cart-icon hidden" data-cart-type="product">
                    <i class="fas fa-shopping-bag"></i>
                    <span id="product-cart-badge" class="cart-badge">0</span>
                </div>
                <div id="milk-cart-icon" class="header-cart-icon hidden" data-cart-type="milk">
                    <i class="fas fa-hand-holding-heart"></i>
                    <span id="milk-cart-badge" class="cart-badge">0</span>
                </div>
                <!-- Language Selector -->
                <div class="language-selector"><a class="lang-btn" data-lang="en">EN</a> | <a class="lang-btn active" data-lang="vi">VI</a></div>
            </div>
        </nav>
    </header>

    <!-- ======== Footer Template (from Code 1) ======== -->
    <template id="contact-footer-template">
        <footer class="contact-footer">
            <h3 data-lang-key="contactUs"></h3>
            <div class="contact-info">
                <a href="https://www.facebook.com/profile.php?id=61578581430202" target="_blank" rel="noopener noreferrer" aria-label="Facebook"><svg viewBox="0 0 24 24"><path d="M12 2.04C6.5 2.04 2 6.53 2 12.06c0 5.06 3.67 9.25 8.44 10v-7.03h-2.5v-2.92h2.5v-2.17c0-2.47 1.46-3.85 3.75-3.85 1.08 0 2 .08 2.27.11v2.6h-1.5c-1.2 0-1.43.57-1.43 1.4v1.86h2.9l-.38 2.92h-2.52V22.06C18.33 21.31 22 17.12 22 12.06c0-5.53-4.5-10.02-10-10.02z"/></svg></a>
                <a href="https://www.instagram.com/_mam.2025_/" target="_blank" rel="noopener noreferrer" aria-label="Instagram"><svg viewBox="0 0 24 24"><path d="M12 2c-2.72 0-3.05.01-4.12.06-1.06.05-1.79.23-2.42.47-.65.25-1.23.59-1.79 1.15-.56.56-.9 1.14-1.15 1.79-.24.63-.42 1.36-.47 2.42C2.01 8.95 2 9.28 2 12s.01 3.05.06 4.12c.05 1.06.23 1.79.47 2.42.25.65.59 1.23 1.15 1.79.56.56 1.14.9 1.79 1.15.63.24 1.36.42 2.42.47 1.07.05 1.4.06 4.12.06s3.05-.01 4.12-.06c1.06-.05 1.79-.23 2.42-.47.65-.25 1.23-.59 1.79-1.15.56.56.9-1.14 1.15-1.79.24-.63-.42-1.36-.47-2.42.05-1.07.06-1.4.06-4.12s-.01-3.05-.06-4.12c-.05-1.06-.23-1.79-.47-2.42-.25-.65-.59-1.23-1.15-1.79-.56-.56-1.14-.9-1.79-1.15-.63-.24-1.36-.42-2.42-.47C15.05 2.01 14.72 2 12 2zm0 1.62c2.67 0 2.99.01 4.05.06 1-.05 1.5.11 1.8.22.38.13.62.3.8.5.17.18.34.42.48.8.11.3.27.8.22 1.8.05 1.06.06 1.38.06 4.05s-.01 2.99-.06 4.05c-.05 1-.11 1.5-.22 1.8-.13.38-.3.62-.5.8-.18.17-.42.34-.8.48-.3.11-.8.27-1.8.22-1.06.05-1.38.06-4.05.06s-2.99-.01-4.05-.06c-1-.05-1.5-.11-1.8-.22-.38-.13-.62-.3-.8-.5-.17-.18-.34-.42-.48-.8-.11-.3-.27-.8-.22-1.8C3.63 15 3.62 14.67 3.62 12s.01-2.99.06-4.05c.05-1 .11-1.5.22-1.8.13-.38.3-.62.5-.8.18-.17-.42.34.8-.48.3-.11.8-.27 1.8-.22C9.01 3.63 9.33 3.62 12 3.62zM12 7.25c-2.62 0-4.75 2.13-4.75 4.75S9.38 16.75 12 16.75s4.75-2.13 4.75-4.75S14.62 7.25 12 7.25zm0 7.88c-1.73 0-3.12-1.4-3.12-3.12s1.4-3.12 3.12-3.12 3.12 1.4 3.12 3.12-1.4 3.12-3.12 3.12zm6.22-8.3c-.6 0-1.08.48-1.08 1.08s.48 1.08 1.08 1.08 1.08-.48 1.08-1.08-.48-1.08-1.08-1.08z"/></svg></a>
                <span>Hotline: 0903252618</span>
                <span>Email: mam.dms42025@gmail.com</span>
            </div>
        </footer>
    </template>

    <!-- ======== Page 3: About Us (from Code 1) ======== -->
    <div id="page3" class="page-content hidden">
        <section class="about-section about-decorations">
            <div class="logo-main"><img src="logo.png" alt="măm logo"></div>
            <p class="slogan-sub" data-lang-key="slogan"></p>
            <div class="decorations"><div class="shape circle"></div><div class="shape star"></div><div class="shape heart"></div><div class="shape triangle"></div><div class="shape circle c2"></div><div class="shape triangle t2"></div></div>
        </section>
        <section class="photo-frame-section">
            <video src="video_homepage_1.mp4" autoplay muted loop playsinline class="about-video"></video>
            <div class="text-overlay"><p data-lang-key="aboutText1"></p></div>
        </section>
        <section class="about-section scroll-banner">
            <div class="scroll-text">
                <span data-lang-key="scrollBanner"></span><span data-lang-key="scrollBanner"></span><span data-lang-key="scrollBanner"></span><span data-lang-key="scrollBanner"></span>
            </div>
        </section>
        <section class="decorative-line-section"><img src="decor_line.png" alt="Decorative line element"></section>
        <section class="about-section final-text"><p data-lang-key="aboutText2"></p></section>
        <div id="feature-sections-container">
            <section class="feature-section"> <div class="feature-text"> <h2 data-lang-key="connect_title"></h2> <p data-lang-key="feature_paragraph_connect"></p> <a href="#" class="more-button" data-target="page4" data-lang-key="more_button"></a> </div> <div class="feature-image"></div> </section>
            <section class="feature-section"> <div class="feature-text"> <h2 data-lang-key="rent_title"></h2> <p data-lang-key="feature_paragraph_rent"></p> <a href="#" class="more-button" data-target="page5" data-lang-key="more_button"></a> </div> <div class="feature-image"></div> </section>
            <section class="feature-section"> <div class="feature-text"> <h2 data-lang-key="handbook_title"></h2> <p data-lang-key="feature_paragraph_handbook"></p> <a href="#" class="more-button" data-target="page6" data-lang-key="more_button"></a> </div> <div class="feature-image"></div> </section>
        </div>
    </div>

    <!-- ======== Page 4: Breast Milk Connection (Structure from Code 2) ======== -->
    <div id="page4" class="page-content hidden">
        <div class="content-container">
            <div class="page-header"><h1 data-lang-key="connect_title_main"></h1></div>
            <div id="milk-post-grid" class="grid-container">
                <!-- Milk posts will be dynamically inserted here by JavaScript -->
            </div>
        </div>
    </div>
    
    <!-- ======== Page 5: Rent/Pass Items (Structure from Code 2) ======== -->
    <div id="page5" class="page-content hidden">
        <div class="content-container">
            <div class="page-header"><h1 data-lang-key="rent_title_main"></h1></div>
            <div id="product-grid" class="grid-container">
                <!-- Products will be dynamically inserted here by JavaScript -->
            </div>
        </div>
    </div>

    <!-- ======== Page 6: Handbook (NEW CONTENT) ======== -->
    <div id="page6" class="page-content hidden">
        <div class="content-container">
            <div class="page-header">
                <h1 data-lang-key="handbook"></h1>
                <div class="handbook-choice-container">
                    <button id="show-pregnancy-handbook-btn" class="handbook-choice-btn active" data-lang-key="pregnancy_handbook_title"></button>
                    <button id="show-postpartum-handbook-btn" class="handbook-choice-btn" data-lang-key="postpartum_handbook_title"></button>
                </div>
            </div>

            <!-- Pregnancy Handbook Form -->
            <div id="pregnancy-form-container" class="handbook-form-container">
                <form id="pregnancy-handbook-form">
                    <div class="form-group"><label for="mom-name-preg" data-lang-key="h_mom_name"></label><input type="text" id="mom-name-preg" required></div>
                    <div class="form-group"><label for="mom-age-preg" data-lang-key="h_mom_age"></label><input type="number" id="mom-age-preg" required></div>
                    <div class="form-group"><label for="mom-weight-height-preg" data-lang-key="h_mom_weight_height"></label><input type="text" id="mom-weight-height-preg" required></div>
                    <div class="form-group"><label for="lmp-date" data-lang-key="h_lmp_date"></label><input type="date" id="lmp-date" required></div>
                    <div class="form-group"><label for="mom-history" data-lang-key="h_mom_history"></label><textarea id="mom-history" rows="2"></textarea></div>
                    <div class="form-group"><label for="mom-lifestyle" data-lang-key="h_mom_lifestyle"></label><textarea id="mom-lifestyle" rows="2"></textarea></div>
                    <div class="form-group"><label for="mom-allergies" data-lang-key="h_mom_allergies"></label><textarea id="mom-allergies" rows="2"></textarea></div>
                    <button type="submit" class="submit-btn" data-lang-key="h_create_btn"></button>
                </form>
            </div>

            <!-- Postpartum Handbook Form -->
            <div id="postpartum-form-container" class="handbook-form-container hidden">
                <form id="postpartum-handbook-form">
                    <h3 data-lang-key="h_baby_info"></h3>
                    <div class="form-group"><label for="baby-name" data-lang-key="h_baby_name"></label><input type="text" id="baby-name" required></div>
                    <div class="form-group"><label for="baby-nickname" data-lang-key="h_baby_nickname"></label><input type="text" id="baby-nickname"></div>
                    <div class="form-group"><label for="baby-dob" data-lang-key="h_baby_dob"></label><input type="date" id="baby-dob" required></div>
                    <div class="form-group"><label for="baby-birth-weight" data-lang-key="h_baby_birth_weight"></label><input type="text" id="baby-birth-weight" required></div>
                    <div class="form-group"><label for="baby-birth-order" data-lang-key="h_baby_birth_order"></label><input type="text" id="baby-birth-order"></div>
                    <div class="form-group"><label for="baby-delivery-method" data-lang-key="h_baby_delivery_method"></label><input type="text" id="baby-delivery-method"></div>
                    <div class="form-group"><label for="baby-vaccines" data-lang-key="h_baby_vaccines"></label><textarea id="baby-vaccines" rows="2"></textarea></div>
                    <div class="form-group"><label for="baby-care-wishes" data-lang-key="h_baby_care_wishes"></label><textarea id="baby-care-wishes" rows="2"></textarea></div>

                    <h3 data-lang-key="h_mom_info_post"></h3>
                     <div class="form-group"><label for="mom-name-post" data-lang-key="h_mom_name"></label><input type="text" id="mom-name-post" required></div>
                    <div class="form-group"><label for="mom-dob-post" data-lang-key="h_mom_dob"></label><input type="date" id="mom-dob-post" required></div>
                    <div class="form-group"><label for="mom-health-status" data-lang-key="h_mom_health_status"></label><textarea id="mom-health-status" rows="2"></textarea></div>
                    <div class="form-group"><label for="mom-milk-status" data-lang-key="h_mom_milk_status"></label><textarea id="mom-milk-status" rows="2"></textarea></div>
                    <div class="form-group"><label for="mom-feeding-plan" data-lang-key="h_mom_feeding_plan"></label><input type="text" id="mom-feeding-plan"></div>
                    
                    <button type="submit" class="submit-btn" data-lang-key="h_create_btn"></button>
                </form>
            </div>

            <!-- Handbook Result Container -->
            <div id="handbook-result-container" class="hidden"></div>
        </div>
    </div>
    
    <!-- ======== Page 8: Login/Register (Structure from Code 2, styled by Code 1) ======== -->
    <div id="page8" class="page-content hidden">
        <div class="form-wrapper">
            <a href="#" id="close-login-page-btn" class="close-form-btn" title="Go Back">×</a>
            <div class="form-toggle">
                <button id="show-login-btn" class="active" data-lang-key="login"></button>
                <button id="show-register-btn" data-lang-key="register"></button>
            </div>
            <!-- Login Form -->
            <div id="login-form-container">
                <h2 data-lang-key="login_account"></h2>
                <div class="social-login">
                    <button id="google-login-btn" class="social-btn google"><i class="fab fa-google"></i> <span data-lang-key="login_google"></span></button>
                    <button id="facebook-login-btn" class="social-btn facebook"><i class="fab fa-facebook-f"></i> <span data-lang-key="login_facebook"></span></button>
                </div>
                <div class="divider"><p>HOẶC</p></div>
                <form id="login-form">
                    <input type="email" name="email" placeholder="Email" required>
                    <input type="password" name="password" data-placeholder-key="password" required>
                    <button type="submit" class="submit-btn" data-lang-key="login"></button>
                </form>
            </div>
            <!-- Register Form -->
            <div id="register-form-container" class="hidden">
                 <h2 data-lang-key="register_account"></h2>
                <div class="social-login">
                    <button id="google-register-btn" class="social-btn google"><i class="fab fa-google"></i> <span data-lang-key="register_google"></span></button>
                    <button id="facebook-register-btn" class="social-btn facebook"><i class="fab fa-facebook-f"></i> <span data-lang-key="register_facebook"></span></button>
                </div>
                <div class="divider"><p>HOẶC</p></div>
                <form id="register-form">
                    <input type="email" name="email" data-placeholder-key="email_address" required>
                    <input type="password" name="password" data-placeholder-key="create_password" required>
                    <button type="submit" class="submit-btn" data-lang-key="register"></button>
                </form>
            </div>
        </div>
    </div>

    <!-- ======== NEW: Page 9: Cart Page ======== -->
    <div id="page9" class="page-content hidden">
        <div class="page-header content-container">
            <h1 data-lang-key="cart_title"></h1>
        </div>
        <div id="cart-page-container">
            <div id="cart-items-section">
                <!-- Cart items will be dynamically inserted here -->
            </div>
            <div id="delivery-info-section">
                <h2 data-lang-key="delivery_info_title"></h2>
                <form id="delivery-form">
                    <div class="form-group">
                        <label for="recipient-name" data-lang-key="recipient_name"></label>
                        <input type="text" id="recipient-name" required>
                    </div>
                    <div class="form-group">
                        <label for="recipient-phone" data-lang-key="recipient_phone"></label>
                        <input type="tel" id="recipient-phone" required>
                    </div>
                    <div class="form-group">
                        <label for="recipient-address" data-lang-key="recipient_address"></label>
                        <input type="text" id="recipient-address" required>
                    </div>
                    <div class="form-group">
                        <label for="payment-method" data-lang-key="payment_method"></label>
                        <select id="payment-method" required>
                            <option value="cod" data-lang-key="payment_cod"></option>
                            <option value="bank" data-lang-key="payment_bank"></option>
                        </select>
                    </div>
                    <button type="submit" class="submit-btn" data-lang-key="place_order"></button>
                </form>
            </div>
        </div>
    </div>

    <!-- Floating "+" Button -->
    <button id="post-item-btn" class="post-item-btn hidden" data-lang-key-aria="postNew"> 
        <i class="fas fa-plus"></i> 
    </button>

    <!-- Modal for Adding Products -->
    <div id="add-item-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 data-lang-key="addItemTitle"></h2>
                <button class="modal-close-btn">×</button>
            </div>
            <form id="add-item-form">
                <div class="form-group"><label data-lang-key="itemName" for="itemName"></label><input type="text" id="itemName" name="itemName" required></div>
                <div class="form-group"><label data-lang-key="itemBrand" for="itemBrand"></label><input type="text" id="itemBrand" name="itemBrand"></div>
                <div class="form-group"><label data-lang-key="itemCondition" for="itemCondition"></label>
                    <select id="itemCondition" name="itemCondition" required>
                        <option value="Mới" data-lang-key="conditionNew"></option>
                        <option value="Đã dùng - Như mới" data-lang-key="conditionLikeNew"></option>
                        <option value="Đã dùng - Tốt" data-lang-key="conditionGood"></option>
                        <option value="Đã dùng - Khá" data-lang-key="conditionFair"></option>
                    </select>
                </div>
                <div class="form-group"><label data-lang-key="salePrice" for="salePrice"></label><input type="number" id="salePrice" name="salePrice" data-placeholder-key="price_note"></div>
                <div class="form-group"><label data-lang-key="itemDescription" for="itemDescription"></label><textarea id="itemDescription" name="itemDescription" rows="3" required></textarea></div>
                <div class="form-group"><label data-lang-key="itemImage" for="itemImage"></label><input type="file" id="itemImage" name="itemImage" accept="image/*" required></div>
                <button type="submit" class="submit-btn" data-lang-key="postItemButton"></button>
            </form>
        </div>
    </div>

    <!-- Modal for Adding Milk Posts (from Code 2) -->
    <div id="add-milk-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 data-lang-key="addMilkTitle"></h2>
                <button class="modal-close-btn">×</button>
            </div>
            <form id="add-milk-form">
                <div class="form-group"><label data-lang-key="milkTitleLabel" for="milkTitle"></label><input type="text" id="milkTitle" name="milkTitle" data-placeholder-key="milkTitlePlaceholder" required></div>
                <div class="form-group"><label data-lang-key="milkRegionLabel" for="milkRegion"></label><input type="text" id="milkRegion" name="milkRegion" data-placeholder-key="milkRegionPlaceholder" required></div>
                <div class="form-group"><label data-lang-key="storageDateLabel" for="storageDate"></label><input type="date" id="storageDate" name="storageDate" required></div>
                <div class="form-group"><label data-lang-key="milkNotesLabel" for="milkNotes"></label><textarea id="milkNotes" name="milkNotes" rows="3" data-placeholder-key="milkNotesPlaceholder"></textarea></div>
                <div class="form-group"><label data-lang-key="itemImage" for="milkImage"></label><input type="file" id="milkImage" name="milkImage" accept="image/*"></div>
                <button type="submit" class="submit-btn" data-lang-key="postMilkButton"></button>
            </form>
        </div>
    </div>

    <!-- ======== Floating Chat Widget (from Code 1) ======== -->
    <div id="floating-chat-widget" class="hidden">
        <div id="chat-window">
            <div class="chat-header">
                <span data-lang-key="scan"></span>
                <button class="chat-close-btn">×</button>
            </div>
            <div class="chat-messages" id="chat-messages-box"></div>
            <div class="chat-input-area">
                <input type="file" id="image-upload-input" class="hidden" accept="image/*">
                <label for="image-upload-input" class="image-upload-label"> 
                    <button type="button" aria-label="Attach Image"><i class="fas fa-paperclip"></i></button> 
                </label>
                <textarea id="chat-text-input" data-placeholder-key="type_message" rows="1"></textarea>
                <button type="button" id="send-chat-btn" aria-label="Send Message"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
        <button id="chat-toggle-btn" aria-label="Open Chat">
            <i class="fas fa-comments"></i>
        </button>
    </div>

    <!-- ========================== JAVASCRIPT SECTION (MERGED & UPDATED) ======================== -->

    <!-- Firebase SDKs (from Code 2) -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>

    <script>
        // --- 1. FIREBASE CONFIGURATION (from Code 2) ---
        // QUAN TRỌNG: Thay thế bằng cấu hình Firebase của dự án của bạn.
       const firebaseConfig = {
  apiKey: "AIzaSyDTa9lu-HcrhdkiQXHa9-E0Glj_7f6rnRc",
  authDomain: "mam-2-c06f4.firebaseapp.com",
  projectId: "mam-2-c06f4",
  storageBucket: "mam-2-c06f4.firebasestorage.app",
  messagingSenderId: "494501201303",
  appId: "1:494501201303:web:f32f75d93042964ae5f0d2",
  measurementId: "G-56FZ0TK2FP"
};
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        const googleProvider = new firebase.auth.GoogleAuthProvider();
        const facebookProvider = new firebase.auth.FacebookAuthProvider();

        document.addEventListener('DOMContentLoaded', function() {

            // --- 2. GEMINI API KEY (from Code 1) ---
            // QUAN TRỌNG: Thay thế bằng khóa API Gemini thực tế của bạn.
            const GEMINI_API_KEY = "AIzaSyAS7_OxrBDkgn0bEFMYnxvqsqhbTB5LkNA";

            // --- 3. LANGUAGE & TRANSLATION (UPDATED) ---
            const translations = {
                en: {
                    slogan: "The first buds of life, enough milk - enough things - enough love", start: "Start", about: "About Us", connect: "Breast Milk", rent: "Rent/Pass", handbook: "Handbook", scan: "AI Consultant", login: "Login", register: "Register", explore: "explore", logout: "Logout",
                    aboutText1: "Parenthood is a beautiful journey - but also full of pressure. When breast milk is insufficient or of poor quality. When you have to choose between raising a child well and balancing finances. When you're not sure which milk is real and which is fake - and 'milk pirates' take advantage of trust. When you have too many questions and don't know who to ask. When baby items quickly become redundant - while someone else is in need. For single fathers, the worries are even greater: juggling work, childcare, and being confused by hundreds of products, choices, and conflicting advice. Without a mother's presence, every decision is harder - and lonelier.",
                    scrollBanner: "măm accompanying baby and parents • ",
                    aboutText2: "Mam was born as a community for you – where breast milk is shared transparently, where baby items are passed on at the right time, where you find support, experience, and connection from fathers and mothers who have been and are on the parenting journey. We believe that when parents support each other, no child is left behind.",
                    contactUs: "Contact Us", comingSoon: "Content for this page is coming soon.",
                    connect_title: "Connecting Breast Milk", rent_title: "Rent - Pass Items", handbook_title: "Parenting Handbook",
                    feature_paragraph_connect: "Lack of quality milk, fear of fake milk, and waste of surplus milk are things many mothers face. Besides, single fathers and parents who adopt find it difficult to find breast milk. With Măm, mothers can share or receive breast milk transparently – ensuring safety, checking origin, nearby locations, and no commercialization. Măm is a reliable bridge for kindness to be spread correctly, to the right people.",
                    feature_paragraph_rent: "Newborn items are often used for a short time but are expensive and take up space. Many mothers want to save money or share good used items but lack a reliable place to connect. With Măm, renting or passing on cribs, strollers, breast pumps... becomes easy, clear, and safe. No more waste, no more clutter — just convenience and kindness among mothers.",
                    feature_paragraph_handbook: "First-time parenting always comes with worries: why is the baby crying? Forgetting vaccination schedules? How to raise a child correctly at each stage? Măm's Handbook section accompanies parents through each of the baby's developmental milestones, reminding them of vaccination schedules, sharing practical experiences, and explaining child behavior in an easy-to-understand way – to make the parenting journey more confident and gentle.",
                    more_button: "Learn More",
                    connect_title_main: "Breast Milk Connection", rent_title_main: "Rent - Pass Items",
                    login_account: "Login to your Account", register_account: "Create New Account",
                    login_google: "Login with Google", login_facebook: "Login with Facebook",
                    register_google: "Register with Google", register_facebook: "Register with Facebook",
                    password: "Password", email_address: "Email Address", create_password: "Create Password",
                    postNew: "Post new item",
                    addItemTitle: "Add New Rent/Pass Item", addMilkTitle: "Post a Milk Connection",
                    itemName: "Product Name", itemBrand: "Brand", itemCondition: "Condition",
                    conditionNew: "New", conditionLikeNew: "Used - Like New", conditionGood: "Used - Good", conditionFair: "Used - Fair",
                    salePrice: "Sale Price (VND)", price_note: "Leave blank if for free",
                    itemDescription: "Description", itemImage: "Image", postItemButton: "Post Item",
                    milkTitleLabel: "Title", milkTitlePlaceholder: "e.g., Donating frozen breast milk for baby",
                    milkRegionLabel: "Region (City/Province)", milkRegionPlaceholder: "e.g., Ho Chi Minh City",
                    storageDateLabel: "Storage Date", milkNotesLabel: "Additional Notes",
                    milkNotesPlaceholder: "e.g., Milk expressed daily, properly frozen, mother not on medication...",
                    postMilkButton: "Post Connection", type_message: "Type your message...",
                    aiGreeting: "Hello! I am măm's AI childcare consultant. Please tell me your question, and I'll ask for some details about your child to give the best advice.",
                    aiAskAge: "To give the best advice, could you please tell me your child's age (e.g., '14 months', '3 years old')?",
                    aiAskWeight: "Thank you. And what is your child's current weight (e.g., '10kg')?",
                    aiAskHealth: "Got it. Lastly, could you briefly describe your child's general health (e.g., 'healthy', 'has a slight cough')?",
                    aiReady: "Thank you for the information! Let me think about your question now...",
                    aiInvalidAge: "I'm sorry, I didn't quite understand the age. Please provide it in a clear format like '6 months' or '2 years'.",
                    aiInvalidWeight: "My apologies, I couldn't determine the weight. Please provide it in a clear format like '7kg' or '11.5 kg'.",
                    aiDisclaimer: "Remember, I am an AI assistant. Always consult a pediatrician for serious health concerns.",
                    label_brand: "Brand:", label_condition: "Condition:", label_region: "Region:", label_storage_date: "Storage Date:", label_notes: "Notes:",
                    not_specified: "Not specified", for_free: "For Free", no_notes: "None",
                    contact_seller: "Contact Seller", contact_giver: "Contact Giver", add_to_cart: "Add to Cart",
                    cart_title: "Your Cart", delivery_info_title: "Delivery Information",
                    recipient_name: "Recipient's Name", recipient_phone: "Phone Number", recipient_address: "Address",
                    payment_method: "Payment Method", payment_cod: "Cash on Delivery (COD)", payment_bank: "Bank Transfer",
                    place_order: "Place Order", item_added_to_cart: "Item added to cart!", item_removed_from_cart: "Item removed from cart.",
                    order_placed_success: "Order placed successfully! The owner will contact you soon.",
                    cart_is_empty: "Your cart is empty.",
                    please_login_cart: "You need to log in to use the cart!",
                    cannot_add_own_item: "You cannot add your own item to the cart.",
                    item_in_cart: "This item is already in your cart!",
                    // Handbook Translations
                    pregnancy_handbook_title: "Pregnancy Handbook", postpartum_handbook_title: "Postpartum Handbook",
                    h_mom_name: "Mom's Name", h_mom_age: "Mom's Age", h_mom_weight_height: "Current Weight & Height (e.g., 55kg, 1.6m)",
                    h_lmp_date: "First Day of Last Period", h_mom_history: "Pregnancy/Medical History", h_mom_lifestyle: "Lifestyle & Dietary Habits",
                    h_mom_allergies: "Drug/Food Allergies", h_create_btn: "Create Handbook", h_baby_info: "Baby's Information",
                    h_baby_name: "Baby's Name", h_baby_nickname: "Nickname", h_baby_dob: "Baby's Date of Birth", h_baby_birth_weight: "Birth Weight (e.g., 3.2kg)",
                    h_baby_birth_order: "Birth Order (e.g., First child)", h_baby_delivery_method: "Delivery Method (e.g., Natural, C-section)",
                    h_baby_vaccines: "Vaccinations Received (Name, Date)", h_baby_care_wishes: "Care Desires/Goals",
                    h_mom_info_post: "Mother's Information (Postpartum)", h_mom_dob: "Mom's Date of Birth", h_mom_health_status: "Current Health Status",
                    h_mom_milk_status: "Breast Milk Status", h_mom_feeding_plan: "Desired Feeding Plan (e.g., Exclusive breastfeeding)"
                },
                vi: {
                    slogan: "Những mầm non đầu đời, đủ sữa - đủ đồ - đủ đầy yêu thương", start: "Bắt đầu", about: "Về chúng tôi", connect: "Kết nối sữa mẹ", rent: "Thuê - Pass đồ", handbook: "Cẩm nang", scan: "Tư vấn AI", login: "Đăng nhập", register: "Đăng ký", explore: "khám<br>phá", logout: "Đăng xuất",
                    aboutText1: "Làm cha mẹ là hành trình tuyệt đẹp – nhưng cũng đầy áp lực.Khi sữa mẹ không đủ, hoặc chất lượng kém. Khi phải chọn giữa việc nuôi con tốt hay cân đối tài chính. Khi bạn không chắc đâu là sữa thật, đâu là giả – và những “tặc sữa” lợi dụng lòng tin. Khi bạn có quá nhiều câu hỏi mà không biết hỏi ai. Khi đồ đạc cho con nhanh chóng trở nên thừa thãi – trong khi có người khác lại đang cần.Với những ông bố đơn thân, nỗi lo còn lớn hơn: vừa đi làm, vừa chăm con, vừa bối rối giữa hàng trăm sản phẩm, lựa chọn, và lời khuyên mâu thuẫn. Không có mẹ bên cạnh, mọi quyết định đều khó khăn hơn – và cô đơn hơn.", 
                    scrollBanner: "măm đồng hành cùng bé và ba mẹ • ", 
                    aboutText2: "Măm ra đời như một cộng đồng dành cho bạn – nơi sữa mẹ được chia sẻ minh bạch, nơi đồ dùng cho bé được trao tay đúng lúc, nơi bạn tìm thấy sự hỗ trợ, kinh nghiệm và kết nối từ những người cha, người mẹ đã và đang đồng hành trên hành trình nuôi con.Chúng tôi tin rằng: khi cha mẹ cùng hỗ trợ nhau, không đứa trẻ nào bị bỏ lại phía sau.", 
                    contactUs: "Liên hệ", comingSoon: "Nội dung cho trang này sẽ sớm được cập nhật.",
                    connect_title: "Kết Nối Sữa Mẹ", rent_title: "Thuê - Pass Đồ", handbook_title: "Cẩm Nang Nuôi Dạy Con", 
                    feature_paragraph_connect: "Thiếu sữa chất lượng, nỗi lo sữa giả, và sự lãng phí sữa dư là điều mà nhiều bà mẹ đang đối mặt. Bên cạnh đó, những ông bố đơn thân, cha mẹ hiến muộn nhận con nuôi khó khăn với việc tìm kiếm sữa mẹ. Với Măm, các mẹ có thể chia sẻ hoặc nhận sữa mẹ một cách minh bạch – đảm bảo an toàn, kiểm tra nguồn gốc, vị trí gần nhau, và không bị thương mại hóa. Măm là cầu nối tin cậy để lòng tốt được lan tỏa đúng cách, đúng người.",
                    feature_paragraph_rent: "Đồ dùng cho trẻ sơ sinh thường chỉ sử dụng trong thời gian ngắn nhưng lại tốn kém và chiếm diện tích. Nhiều mẹ muốn tiết kiệm hoặc san sẻ đồ cũ còn tốt, nhưng thiếu nơi tin cậy để kết nối. Với Măm, việc thuê hoặc pass lại nôi, xe đẩy, máy hút sữa... trở nên dễ dàng, rõ ràng và an toàn. Không còn lãng phí, không còn cất đầy nhà — chỉ còn sự tiện lợi và tử tế giữa những người mẹ.",
                    feature_paragraph_handbook: "Lần đầu làm cha mẹ luôn đi kèm lo lắng: trẻ khóc vì đâu? Quên lịch tiêm chủng? Nuôi con ra sao đúng từng giai đoạn? Chuyên mục Cẩm nang của Măm đồng hành cùng ba mẹ qua từng cột mốc phát triển của bé, nhắc lịch tiêm, chia sẻ kinh nghiệm thực tế và giải thích hành vi trẻ dễ hiểu – để hành trình làm cha mẹ trở nên vững vàng và nhẹ nhàng hơn.",
                    more_button: "Tìm hiểu thêm",
                    connect_title_main: "Kết Nối Sữa Mẹ", rent_title_main: "Thuê - Pass Đồ",
                    login_account: "Đăng nhập vào tài khoản", register_account: "Tạo tài khoản mới",
                    login_google: "Đăng nhập với Google", login_facebook: "Đăng nhập với Facebook",
                    register_google: "Đăng ký với Google", register_facebook: "Đăng ký với Facebook",
                    password: "Mật khẩu", email_address: "Địa chỉ Email", create_password: "Tạo mật khẩu",
                    postNew: "Đăng tin mới",
                    addItemTitle: "Thêm sản phẩm cho thuê/pass", addMilkTitle: "Đăng tin kết nối sữa mẹ",
                    itemName: "Tên sản phẩm", itemBrand: "Thương hiệu", itemCondition: "Tình trạng",
                    conditionNew: "Mới", conditionLikeNew: "Đã dùng - Như mới", conditionGood: "Đã dùng - Tốt", conditionFair: "Đã dùng - Khá",
                    salePrice: "Giá bán (VNĐ)", price_note: "Để trống nếu cho tặng",
                    itemDescription: "Mô tả", itemImage: "Hình ảnh", postItemButton: "Đăng sản phẩm",
                    milkTitleLabel: "Tiêu đề", milkTitlePlaceholder: "ví dụ: Tặng sữa mẹ trữ đông cho bé",
                    milkRegionLabel: "Khu vực (Tỉnh/Thành phố)", milkRegionPlaceholder: "ví dụ: TP. Hồ Chí Minh",
                    storageDateLabel: "Ngày trữ đông", milkNotesLabel: "Ghi chú thêm",
                    milkNotesPlaceholder: "ví dụ: Sữa mẹ vắt hàng ngày, trữ đông đúng quy trình...",
                    postMilkButton: "Đăng tin", type_message: "Nhập tin nhắn của bạn...",
                    aiGreeting: "Xin chào! Tôi là trợ lý AI tư vấn nuôi dạy con của măm. Bạn hãy cho tôi biết câu hỏi của bạn, tôi sẽ hỏi một vài thông tin về bé để đưa ra tư vấn tốt nhất nhé.",
                    aiAskAge: "Để đưa ra lời khuyên tốt nhất, bạn vui lòng cho tôi biết tuổi của bé được không (ví dụ: '14 tháng', '3 tuổi')?",
                    aiAskWeight: "Cảm ơn bạn. Bé nhà mình hiện nặng bao nhiêu kg ạ (ví dụ: '10kg')?",
                    aiAskHealth: "Tôi hiểu rồi. Cuối cùng, bạn có thể mô tả sơ qua về tình hình sức khỏe chung của bé không (ví dụ: 'khỏe mạnh', 'đang ho nhẹ')?",
                    aiReady: "Cảm ơn bạn đã cung cấp thông tin! Bây giờ hãy để tôi suy nghĩ về câu hỏi của bạn nhé...",
                    aiInvalidAge: "Xin lỗi, tôi chưa hiểu rõ về tuổi của bé. Bạn vui lòng cung cấp dưới dạng như '6 tháng' hoặc '2 tuổi' nhé.",
                    aiInvalidWeight: "Xin lỗi, tôi chưa xác định được cân nặng. Bạn vui lòng cung cấp dưới dạng như '7kg' hoặc '11.5 kg' nhé.",
                    aiDisclaimer: "Lưu ý: Tôi là một trợ lý AI. Hãy luôn tham khảo ý kiến bác sĩ nhi khoa cho các vấn đề sức khỏe nghiêm trọng.",
                    label_brand: "Thương hiệu:", label_condition: "Tình trạng:", label_region: "Khu vực:", label_storage_date: "Ngày trữ:", label_notes: "Ghi chú:",
                    not_specified: "Không rõ", for_free: "Cho tặng", no_notes: "Không có",
                    contact_seller: "Liên hệ người bán", contact_giver: "Liên hệ người tặng", add_to_cart: "Thêm vào giỏ",
                    cart_title: "Giỏ hàng của bạn", delivery_info_title: "Thông tin giao hàng",
                    recipient_name: "Tên người nhận", recipient_phone: "Số điện thoại", recipient_address: "Địa chỉ",
                    payment_method: "Phương thức thanh toán", payment_cod: "Thanh toán khi nhận hàng (COD)", payment_bank: "Chuyển khoản ngân hàng",
                    place_order: "Đặt hàng", item_added_to_cart: "Đã thêm sản phẩm vào giỏ hàng!", item_removed_from_cart: "Đã xóa sản phẩm khỏi giỏ hàng.",
                    order_placed_success: "Đặt hàng thành công! Người bán/tặng sẽ sớm liên hệ với bạn.",
                    cart_is_empty: "Giỏ hàng của bạn đang trống.",
                    please_login_cart: "Bạn cần đăng nhập để sử dụng giỏ hàng!",
                    cannot_add_own_item: "Bạn không thể thêm sản phẩm của chính mình vào giỏ hàng.",
                    item_in_cart: "Sản phẩm này đã có trong giỏ hàng!",
                     // Handbook Translations
                    pregnancy_handbook_title: "Cẩm Nang Thai Kỳ", postpartum_handbook_title: "Cẩm Nang Sau Sinh",
                    h_mom_name: "Tên mẹ", h_mom_age: "Tuổi mẹ", h_mom_weight_height: "Cân nặng & chiều cao hiện tại (ví dụ: 55kg, 1m6)",
                    h_lmp_date: "Ngày đầu kỳ kinh cuối", h_mom_history: "Tiền sử thai sản/bệnh lý", h_mom_lifestyle: "Lối sống, thói quen ăn uống",
                    h_mom_allergies: "Dị ứng thuốc, đồ ăn", h_create_btn: "Tạo cẩm nang", h_baby_info: "Thông tin của bé",
                    h_baby_name: "Tên bé", h_baby_nickname: "Tên ở nhà", h_baby_dob: "Ngày sinh của bé", h_baby_birth_weight: "Cân nặng lúc sinh (ví dụ: 3.2kg)",
                    h_baby_birth_order: "Con thứ mấy", h_baby_delivery_method: "Hình thức sinh (ví dụ: Sinh thường, sinh mổ)",
                    h_baby_vaccines: "Đã tiêm mũi nào, ngày mấy", h_baby_care_wishes: "Mong muốn chăm sóc",
                    h_mom_info_post: "Thông tin của mẹ (Sau sinh)", h_mom_dob: "Ngày sinh của mẹ", h_mom_health_status: "Tình trạng sức khỏe hiện tại",
                    h_mom_milk_status: "Tình trạng sữa mẹ", h_mom_feeding_plan: "Mong muốn cho bé bú (ví dụ: Sữa mẹ hoàn toàn)"
                }
            };

            let currentLang = 'vi';
            const typeText = (element, text) => { if (!element) return; element.innerHTML = ''; let i = 0; const cursor = document.createElement('span'); cursor.className = 'cursor'; cursor.innerHTML = ' '; element.appendChild(cursor); const typing = setInterval(() => { if (i < text.length) { cursor.insertAdjacentText('beforebegin', text.charAt(i)); i++; } else { clearInterval(typing); cursor.style.animation = 'blink 1s infinite'; } }, 50); };
            
            const setLanguage = (lang) => { 
                currentLang = lang; 
                document.documentElement.lang = lang;
                document.querySelectorAll('[data-lang-key]').forEach(el => { 
                    const key = el.dataset.langKey; 
                    const text = translations[lang][key] || ''; 
                    if (el.classList.contains('slogan')) { typeText(el, text); } 
                    else if (key === 'explore') { el.innerHTML = text; } 
                    else { el.textContent = text; } 
                });
                document.querySelectorAll('[data-lang-key-aria]').forEach(el => {
                    const key = el.dataset.langKeyAria;
                    const text = translations[lang][key] || '';
                    el.setAttribute('aria-label', text);
                });
                document.querySelectorAll('[data-placeholder-key]').forEach(el => {
                    const key = el.dataset.placeholderKey;
                    const text = translations[lang][key] || '';
                    el.placeholder = text;
                });
                document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.lang === lang)); 
                
                // Re-render dynamic content with new language
                const currentPageId = document.querySelector('body > div[id^="page"]:not(.hidden)')?.id;
                if (currentPageId === 'page4') displayMilkPosts();
                if (currentPageId === 'page5') displayProducts();
                if (currentPageId === 'page9') {
                    const activeCartType = document.getElementById('product-cart-icon').classList.contains('hidden') ? 'milk' : 'product';
                    displayCartPage(activeCartType);
                }
            };
            document.querySelectorAll('.lang-btn').forEach(btn => btn.addEventListener('click', (e) => setLanguage(e.target.dataset.lang)));

            // --- 4. UI ELEMENTS & NAVIGATION (MERGED LOGIC) ---
            const pages = document.querySelectorAll('body > div[id^="page"]');
            const mainHeader = document.getElementById('mainHeader');
            const navLinks = document.querySelectorAll('.nav-item, .nav-logo, .more-button');
            const footerTemplate = document.getElementById('contact-footer-template');
            const floatingChatWidget = document.getElementById('floating-chat-widget');
            
            // Auth UI Elements
            const authLinks = document.getElementById('auth-links');
            const userProfile = document.getElementById('user-profile');
            const userAvatar = document.getElementById('user-avatar');
            const userName = document.getElementById('user-name');
            const logoutBtn = document.getElementById('logout-btn');

            // Floating Button & Modals
            const postItemBtn = document.getElementById('post-item-btn');
            
            // Cart UI Elements
            const productCartIcon = document.getElementById('product-cart-icon');
            const milkCartIcon = document.getElementById('milk-cart-icon');

            let lastPageId = 'page1';

            function showPage(pageId, action) {
                console.log("Hàm showPage được gọi với pageId:", pageId);
                let currentPageId = document.querySelector('body > div[id^="page"]:not(.hidden)')?.id || lastPageId;
                if (!['page8', 'page9'].includes(pageId)) { lastPageId = currentPageId; }
                
                pages.forEach(page => page.classList.add('hidden'));
                const targetPage = document.getElementById(pageId);
                
                if (targetPage) {
                    targetPage.classList.remove('hidden');
                    
                    if(pageId === 'page8'){ 
                        if (action === 'show-register') { document.getElementById('show-register-btn').click(); } 
                        else { document.getElementById('show-login-btn').click(); } 
                    } else { 
                        const existingFooter = targetPage.querySelector('.contact-footer'); 
                        if (existingFooter) existingFooter.remove(); 
                        if (!['page1', 'page2', 'page8'].includes(pageId)) { 
                            targetPage.appendChild(footerTemplate.content.cloneNode(true)); 
                        } 
                    }
                }
                
                const showHeader = !['page1', 'page2', 'page8'].includes(pageId);
                mainHeader.classList.toggle('hidden', !showHeader);

                productCartIcon.classList.toggle('hidden', pageId !== 'page5');
                milkCartIcon.classList.toggle('hidden', pageId !== 'page4');

                if (floatingChatWidget) floatingChatWidget.classList.toggle('hidden', ['page1', 'page2'].includes(pageId));
                
                navLinks.forEach(link => link.classList.toggle('active', link.dataset.target === pageId));
                window.scrollTo(0, 0);

                const isLoggedIn = auth.currentUser;
                const onContentPage = ['page4', 'page5'].includes(pageId);
                postItemBtn.classList.toggle('hidden', !isLoggedIn || !onContentPage);

                if (isLoggedIn && onContentPage) {
                    postItemBtn.dataset.modalTarget = (pageId === 'page4') ? 'add-milk-modal' : 'add-item-modal';
                }

                if (pageId === 'page4') displayMilkPosts();
                if (pageId === 'page5') displayProducts();

                setLanguage(currentLang);
            }
            
            document.getElementById('startButton').addEventListener('click', () => showPage('page2'));
            navLinks.forEach(link => link.addEventListener('click', (e) => { e.preventDefault(); showPage(link.dataset.target, link.dataset.action); }));

            // --- 5. AUTHENTICATION (from Code 2) ---
            auth.onAuthStateChanged(user => {
                updateCartBadges();
                const currentPageId = document.querySelector('body > div[id^="page"]:not(.hidden)')?.id || 'page1';
                if (user) {
                    authLinks.classList.add('hidden');
                    userProfile.classList.remove('hidden');
                    userName.textContent = user.displayName || user.email.split('@')[0];
                    userAvatar.src = user.photoURL || 'https://via.placeholder.com/40';
                    if (currentPageId === 'page8') {
                        showPage(lastPageId !== 'page8' ? lastPageId : 'page2');
                    } else {
                        showPage(currentPageId);
                    }
                } else {
                    authLinks.classList.remove('hidden');
                    userProfile.classList.add('hidden');
                    postItemBtn.classList.add('hidden');
                    if (!['page1', 'page8'].includes(currentPageId)) {
                        showPage(currentPageId);
                    }
                }
            });

            logoutBtn.addEventListener('click', (e) => { e.preventDefault(); auth.signOut().then(() => { lastPageId = 'page1'; showPage('page1'); }); });
            const socialLogin = provider => { auth.signInWithPopup(provider).catch(error => alert(`Đăng nhập thất bại: ${error.message}`)); };
            document.getElementById('google-login-btn').addEventListener('click', () => socialLogin(googleProvider));
            document.getElementById('facebook-login-btn').addEventListener('click', () => socialLogin(facebookProvider));
            document.getElementById('google-register-btn').addEventListener('click', () => socialLogin(googleProvider));
            document.getElementById('facebook-register-btn').addEventListener('click', () => socialLogin(facebookProvider));
            document.getElementById('login-form').addEventListener('submit', e => { e.preventDefault(); auth.signInWithEmailAndPassword(e.target.email.value, e.target.password.value).catch(err => alert(err.message)); });
            document.getElementById('register-form').addEventListener('submit', e => { e.preventDefault(); auth.createUserWithEmailAndPassword(e.target.email.value, e.target.password.value).catch(err => alert(err.message)); });
            const showLoginBtn = document.getElementById('show-login-btn');
            const showRegisterBtn = document.getElementById('show-register-btn');
            const loginContainer = document.getElementById('login-form-container');
            const registerContainer = document.getElementById('register-form-container');
            const closeLoginPageBtn = document.getElementById('close-login-page-btn');
            if(showLoginBtn) showLoginBtn.addEventListener('click', () => { loginContainer.classList.remove('hidden'); registerContainer.classList.add('hidden'); showLoginBtn.classList.add('active'); showRegisterBtn.classList.remove('active'); });
            if(showRegisterBtn) showRegisterBtn.addEventListener('click', () => { loginContainer.classList.add('hidden'); registerContainer.classList.remove('hidden'); showLoginBtn.classList.remove('active'); showRegisterBtn.classList.add('active'); });
            if(closeLoginPageBtn) closeLoginPageBtn.addEventListener('click', (e) => { e.preventDefault(); showPage(lastPageId); });

            // --- 6. REAL-TIME DATA & FORMS (UPDATED for translations) ---
            function displayProducts() {
                const grid = document.getElementById('product-grid');
                if(!grid) return;
                db.collection('products').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                    let content = '';
                    if (snapshot.empty) {
                        content = `<div class="placeholder-page"><p>${translations[currentLang].comingSoon}</p></div>`;
                    } else {
                        snapshot.forEach(doc => {
                            const product = doc.data();
                            const productDataString = JSON.stringify({id: doc.id, ...product}).replace(/'/g, "\\'");
                            const price = product.salePrice && product.salePrice > 0 ? `${Number(product.salePrice).toLocaleString('vi-VN')} VNĐ` : translations[currentLang].for_free;
                            content += `
                                <div class="item-box">
                                    <div class="item-image" style="background-image: url('${product.imageUrl || 'https://via.placeholder.com/300x250?text=măm'}');"></div>
                                    <div class="item-info">
                                        <h3 class="item-name">${product.itemName || translations[currentLang].not_specified}</h3>
                                        <p class="item-price">${price}</p>
                                        <div class="item-details">
                                            <span><strong>${translations[currentLang].label_brand}</strong> ${product.itemBrand || translations[currentLang].not_specified}</span>
                                            <span><strong>${translations[currentLang].label_condition}</strong> ${product.itemCondition || translations[currentLang].not_specified}</span>
                                        </div>
                                        <div class="item-actions">
                                            <button class="action-btn contact-owner-btn" onclick="alert('${translations[currentLang].contact_seller}: ${product.ownerEmail}')">${translations[currentLang].contact_seller}</button>
                                            <button class="action-btn add-to-cart-btn" onclick='addToCart("product", ${productDataString})'>${translations[currentLang].add_to_cart}</button>
                                        </div>
                                    </div>
                                </div>`;
                        });
                    }
                    grid.innerHTML = content;
                }, error => console.error("Error fetching products:", error));
            }

            function displayMilkPosts() {
                const grid = document.getElementById('milk-post-grid');
                if(!grid) return;
                db.collection('milk_posts').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                    let content = '';
                    if (snapshot.empty) {
                        content = `<div class="placeholder-page"><p>${translations[currentLang].comingSoon}</p></div>`;
                    } else {
                        snapshot.forEach(doc => {
                            const post = doc.data();
                            const postDataString = JSON.stringify({id: doc.id, ...post}).replace(/'/g, "\\'");
                            const imageUrl = post.imageUrl || 'https://via.placeholder.com/300x250?text=Sữa+mẹ';
                            content += `
                                <div class="item-box">
                                    <div class="item-image" style="background-image: url('${imageUrl}');"></div>
                                    <div class="item-info">
                                        <h3 class="item-name">${post.milkTitle || translations[currentLang].not_specified}</h3>
                                        <div class="item-details">
                                            <span><strong>${translations[currentLang].label_region}</strong> ${post.milkRegion || translations[currentLang].not_specified}</span>
                                            <span><strong>${translations[currentLang].label_storage_date}</strong> ${post.storageDate || translations[currentLang].not_specified}</span>
                                            <span><strong>${translations[currentLang].label_notes}</strong> ${post.milkNotes || translations[currentLang].no_notes}</span>
                                        </div>
                                        <div class="item-actions">
                                            <button class="action-btn contact-owner-btn" onclick="alert('${translations[currentLang].contact_giver}: ${post.ownerEmail}')">${translations[currentLang].contact_giver}</button>
                                            <button class="action-btn add-to-cart-btn" onclick='addToCart("milk", ${postDataString})'>${translations[currentLang].add_to_cart}</button>
                                        </div>
                                    </div>
                                </div>`;
                        });
                    }
                    grid.innerHTML = content;
                }, error => console.error("Error fetching milk posts:", error));
            }
            
            postItemBtn.addEventListener('click', () => {
                const modalId = postItemBtn.dataset.modalTarget;
                const targetModal = document.getElementById(modalId);
                if (targetModal) {
                    targetModal.classList.add('visible');
                    setLanguage(currentLang);
                }
            });

            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal-overlay') || e.target.classList.contains('modal-close-btn')) {
                        modal.classList.remove('visible');
                    }
                });
            });

            const handleFormSubmit = async (form, collectionName, fileInputName) => {
                const user = auth.currentUser;
                if (!user) { alert('Bạn cần đăng nhập để đăng tin!'); return; }
                const submitButton = form.querySelector('button[type="submit"]');
                const originalButtonText = submitButton.textContent;
                submitButton.disabled = true;
                submitButton.textContent = 'Đang xử lý...';
                try {
                    const fileInput = form.querySelector(`input[name="${fileInputName}"]`);
                    const file = fileInput ? fileInput.files[0] : null;
                    let downloadURL = null;
                    if (file) {
                        const filePath = `${collectionName}/${user.uid}/${Date.now()}_${file.name}`;
                        const fileRef = storage.ref(filePath);
                        await fileRef.put(file);
                        downloadURL = await fileRef.getDownloadURL();
                    }
                    const formData = new FormData(form);
                    const data = { ownerId: user.uid, ownerEmail: user.email, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
                    for (let [key, value] of formData.entries()) { if (key !== fileInputName) data[key] = value; }
                    if (downloadURL) { data.imageUrl = downloadURL; }
                    await db.collection(collectionName).add(data);
                    alert('Đăng tin thành công!');
                    form.reset();
                    form.closest('.modal-overlay').classList.remove('visible');
                } catch (error) { console.error("Submit error:", error); alert(`Đã xảy ra lỗi: ${error.message}`); } 
                finally { submitButton.disabled = false; submitButton.textContent = originalButtonText; }
            };
            
            document.getElementById('add-item-form').addEventListener('submit', e => { e.preventDefault(); handleFormSubmit(e.target, 'products', 'itemImage'); });
            document.getElementById('add-milk-form').addEventListener('submit', e => { e.preventDefault(); handleFormSubmit(e.target, 'milk_posts', 'milkImage'); });
            
            // --- 7. CAROUSEL & OTHER UI LOGIC (from Code 1) ---
            const items = document.querySelectorAll('.carousel-item');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            let currentIndex = 0;
            function updateCarousel() { if (items.length === 0) return; const totalItems = items.length; const prevIndex = (currentIndex - 1 + totalItems) % totalItems; const nextIndex = (currentIndex + 1) % totalItems; items.forEach((item, index) => { item.classList.remove('active', 'prev', 'next'); if (index === currentIndex) item.classList.add('active'); else if (index === prevIndex) item.classList.add('prev'); else if (index === nextIndex) item.classList.add('next'); }); }
            function navigateCarousel(direction) { currentIndex = (currentIndex + direction + items.length) % items.length; updateCarousel(); }
            if(nextBtn) nextBtn.addEventListener('click', () => navigateCarousel(1));
            if(prevBtn) prevBtn.addEventListener('click', () => navigateCarousel(-1));
            items.forEach((item) => { 
                item.addEventListener('click', () => { if (item.classList.contains('active')) showPage(item.dataset.target); else if (item.classList.contains('next')) navigateCarousel(1); else if (item.classList.contains('prev')) navigateCarousel(-1); }); 
                const imageWrapper = item.querySelector('.image-wrapper');
                if (imageWrapper) {
                    imageWrapper.addEventListener('mousemove', (e) => { 
                        if(item.classList.contains('active')){ const follower = item.querySelector('.discovery-follower'); const rect = e.currentTarget.getBoundingClientRect(); follower.style.left = `${e.clientX - rect.left}px`; follower.style.top = `${e.clientY - rect.top}px`; } 
                    }); 
                }
            });
            const page2Observer = new MutationObserver((mutations) => { if(!mutations[0].target.classList.contains('hidden')){ currentIndex = 0; updateCarousel(); } });
            if(document.getElementById('page2')) page2Observer.observe(document.getElementById('page2'), { attributes: true, attributeFilter: ['class'] });

            let lastScrollTop = 0;
            window.addEventListener('scroll', function() { if (mainHeader.classList.contains('hidden')) return; let scrollTop = window.pageYOffset || document.documentElement.scrollTop; mainHeader.style.top = (scrollTop > lastScrollTop && scrollTop > 50) ? '-100px' : '0'; lastScrollTop = scrollTop <= 0 ? 0 : scrollTop; }, false);

            // --- 8. CHAT WIDGET LOGIC (from Code 1) ---
            const chatWindow = document.getElementById('chat-window');
            const chatToggleButton = document.getElementById('chat-toggle-btn');
            const chatCloseButton = chatWindow.querySelector('.chat-close-btn');
            const chatBox = document.getElementById('chat-messages-box');
            const textInput = document.getElementById('chat-text-input');
            const sendBtn = document.getElementById('send-chat-btn');
            let chatState = {}; let isChatInitialized = false;
            function initializeChat() { chatBox.innerHTML = ''; chatState = { conversationStage: 'GREETING', childAge: null, childWeight: null, childHealth: null, originalQuestion: null }; displayAIMessage(translations[currentLang].aiGreeting); isChatInitialized = true; }
            if(chatToggleButton) chatToggleButton.addEventListener('click', () => { chatWindow.classList.toggle('visible'); if (chatWindow.classList.contains('visible') && !isChatInitialized) { initializeChat(); } });
            if(chatCloseButton) chatCloseButton.addEventListener('click', () => { chatWindow.classList.remove('visible'); });
            function displayAIMessage(text, isThinking = false) { const msgDiv = document.createElement('div'); msgDiv.className = 'message ai-message'; msgDiv.textContent = text; if(isThinking) { msgDiv.id = 'thinking-message'; } chatBox.appendChild(msgDiv); chatBox.scrollTop = chatBox.scrollHeight; return msgDiv; }
            function displayUserMessage(text) { const userMsgDiv = document.createElement('div'); userMsgDiv.className = 'message user-message'; const textNode = document.createElement('span'); textNode.textContent = text; userMsgDiv.appendChild(textNode); chatBox.appendChild(userMsgDiv); chatBox.scrollTop = chatBox.scrollHeight; }
            function extractInfo(text, regex, group = 1) { const match = text.toLowerCase().match(regex); return match ? match[group] : null; }
            const handleConversation = (text) => { displayUserMessage(text); switch (chatState.conversationStage) { case 'GREETING': chatState.originalQuestion = text; displayAIMessage(translations[currentLang].aiAskAge); chatState.conversationStage = 'AWAITING_AGE'; break; case 'AWAITING_AGE': const age = extractInfo(text, /\b(\d+\s*(?:tháng|tuổi|month|year)s?)\b/); if (age) { chatState.childAge = age; displayAIMessage(translations[currentLang].aiAskWeight); chatState.conversationStage = 'AWAITING_WEIGHT'; } else { displayAIMessage(translations[currentLang].aiInvalidAge); } break; case 'AWAITING_WEIGHT': const weight = extractInfo(text, /\b(\d+(?:[.,]\d+)?\s*k?g)\b/); if (weight) { chatState.childWeight = weight; displayAIMessage(translations[currentLang].aiAskHealth); chatState.conversationStage = 'AWAITING_HEALTH'; } else { displayAIMessage(translations[currentLang].aiInvalidWeight); } break; case 'AWAITING_HEALTH': chatState.childHealth = text; chatState.conversationStage = 'READY_TO_CONSULT'; const fullPrompt = `You are "măm", a helpful, friendly, and caring AI assistant for a Vietnamese website that supports new parents. Your primary language for responding is Vietnamese. Here is the information about the child: - Age: ${chatState.childAge} - Weight: ${chatState.childWeight} - General Health: ${chatState.childHealth}. The parent's original question is: "${chatState.originalQuestion}". Please provide a comprehensive and caring consultation based on this data. Also, suggest 1-2 types of products (like specific foods, vitamins, or toys) that would be appropriate for this child's age and the context of the question. Always end your response with the medical disclaimer: "${translations.vi.aiDisclaimer}"`; callGeminiAPI(fullPrompt, chatBox); break; case 'READY_TO_CONSULT': const followupPrompt = `You are "măm", a helpful AI assistant. Remember the child's details: Age is ${chatState.childAge}, Weight is ${chatState.childWeight}, Health is ${chatState.childHealth}. The parent now has a follow-up question: "${text}". Please answer this question based on the child's information you already have. Keep the response helpful and concise. Always end with the disclaimer: "${translations.vi.aiDisclaimer}"`; callGeminiAPI(followupPrompt, chatBox); break; } };
            const sendMessage = () => { const text = textInput.value.trim(); if (text === '') return; handleConversation(text); textInput.value = ''; textInput.focus(); };
            if(sendBtn) sendBtn.addEventListener('click', sendMessage);
            if(textInput) textInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });

            // --- 9. CART LOGIC ---
            function getCart(type) { return JSON.parse(localStorage.getItem(type === 'product' ? 'productCart' : 'milkCart')) || []; }
            function saveCart(type, cartData) { localStorage.setItem(type === 'product' ? 'productCart' : 'milkCart', JSON.stringify(cartData)); updateCartBadges(); }
            
            window.addToCart = (type, itemData) => {
                const user = auth.currentUser;
                if (!user) { alert(translations[currentLang].please_login_cart || 'Bạn cần đăng nhập để sử dụng giỏ hàng!'); showPage('page8', 'show-login'); return; }
                if (user.uid === itemData.ownerId) { alert(translations[currentLang].cannot_add_own_item || 'Bạn không thể thêm sản phẩm của chính mình vào giỏ hàng.'); return; }
                
                let cart = getCart(type);
                if (cart.some(item => item.id === itemData.id)) { alert(translations[currentLang].item_in_cart || 'Sản phẩm này đã có trong giỏ hàng!'); return; }
                
                cart.push(itemData);
                saveCart(type, cart);
                alert(translations[currentLang].item_added_to_cart);
            };

            function updateCartBadges() {
                const productCart = getCart('product');
                const milkCart = getCart('milk');
                document.getElementById('product-cart-badge').textContent = productCart.length;
                document.getElementById('milk-cart-badge').textContent = milkCart.length;
            }

            function displayCartPage(type) {
                showPage('page9');
                const cart = getCart(type);
                const container = document.getElementById('cart-items-section');
                const deliverySection = document.getElementById('delivery-info-section');
                
                if (cart.length === 0) {
                    container.innerHTML = `<div class="placeholder-page"><p>${translations[currentLang].cart_is_empty}</p></div>`;
                     deliverySection.classList.add('hidden');
                    return;
                }
                deliverySection.classList.remove('hidden');

                let content = '';
                cart.forEach(item => {
                    const itemName = item.itemName || item.milkTitle || translations[currentLang].not_specified;
                    const itemPrice = item.salePrice && item.salePrice > 0 ? `${Number(item.salePrice).toLocaleString('vi-VN')} VNĐ` : translations[currentLang].for_free;
                    const imageUrl = item.imageUrl || 'https://via.placeholder.com/80x80?text=măm';
                    
                    content += `
                        <div class="cart-item" id="cart-item-${item.id}">
                            <img src="${imageUrl}" alt="${itemName}" class="cart-item-img">
                            <div class="cart-item-info">
                                <h4>${itemName}</h4>
                                <p>${type === 'product' ? itemPrice : ''}</p>
                            </div>
                            <i class="fas fa-trash-alt cart-item-remove-btn" onclick="removeFromCart('${type}', '${item.id}')"></i>
                        </div>
                    `;
                });
                container.innerHTML = content;
                document.getElementById('delivery-form').dataset.cartType = type;
            }

            window.removeFromCart = (type, itemId) => {
                let cart = getCart(type);
                const updatedCart = cart.filter(item => item.id !== itemId);
                saveCart(type, updatedCart);
                alert(translations[currentLang].item_removed_from_cart);
                displayCartPage(type); 
            };

            document.querySelectorAll('.header-cart-icon').forEach(icon => {
                icon.addEventListener('click', (e) => {
                    const type = e.currentTarget.dataset.cartType;
                    displayCartPage(type);
                });
            });

            document.getElementById('delivery-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const type = e.target.dataset.cartType;
                let cart = getCart(type);
                if(cart.length === 0) {
                    alert('Giỏ hàng trống, không thể đặt hàng!');
                    return;
                }
                alert(translations[currentLang].order_placed_success);
                saveCart(type, []);
                showPage(type === 'product' ? 'page5' : 'page4'); 
            });

            // --- 10. NEW: HANDBOOK PAGE LOGIC ---
            const showPregnancyBtn = document.getElementById('show-pregnancy-handbook-btn');
            const showPostpartumBtn = document.getElementById('show-postpartum-handbook-btn');
            const pregnancyFormContainer = document.getElementById('pregnancy-form-container');
            const postpartumFormContainer = document.getElementById('postpartum-form-container');
            const handbookResultContainer = document.getElementById('handbook-result-container');

            showPregnancyBtn.addEventListener('click', () => {
                showPregnancyBtn.classList.add('active');
                showPostpartumBtn.classList.remove('active');
                pregnancyFormContainer.classList.remove('hidden');
                postpartumFormContainer.classList.add('hidden');
                handbookResultContainer.classList.add('hidden');
            });

            showPostpartumBtn.addEventListener('click', () => {
                showPregnancyBtn.classList.remove('active');
                showPostpartumBtn.classList.add('active');
                pregnancyFormContainer.classList.add('hidden');
                postpartumFormContainer.classList.remove('hidden');
                handbookResultContainer.classList.add('hidden');
            });

            document.getElementById('pregnancy-handbook-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const momName = document.getElementById('mom-name-preg').value;
                const momAge = document.getElementById('mom-age-preg').value;
                const momWeightHeight = document.getElementById('mom-weight-height-preg').value;
                const lmpDate = document.getElementById('lmp-date').value;
                const momHistory = document.getElementById('mom-history').value;
                const momLifestyle = document.getElementById('mom-lifestyle').value;
                const momAllergies = document.getElementById('mom-allergies').value;

                const prompt = `Bạn là "măm", một trợ lý AI thân thiện và chuyên nghiệp, chuyên tạo cẩm nang thai kỳ cá nhân hóa cho một trang web Việt Nam. Phản hồi của bạn BẮT BUỘC phải bằng tiếng Việt.

Tạo một cẩm nang dưới dạng mục lục chi tiết. Tiêu đề chính của cẩm nang phải là: "Cẩm Nang Thai Kỳ 3 Tháng Đầu của Mẹ ${momName}".

Cẩm nang phải là một hướng dẫn toàn diện cho tam cá nguyệt thứ nhất (3 tháng đầu). Cấu trúc mục lục một cách logic, bao gồm các chủ đề theo tuần hoặc theo các lĩnh vực chính như:
- Sự phát triển của thai nhi.
- Thay đổi thể chất và cảm xúc của mẹ.
- Dinh dưỡng và chế độ ăn uống được đề xuất.
- Các bài tập được đề nghị.
- Các cuộc kiểm tra và xét nghiệm quan trọng.
- Những điều cần tránh.
- Mẹo quản lý các triệu chứng phổ biến (ốm nghén, mệt mỏi).

Cá nhân hóa lời khuyên dựa trên dữ liệu người dùng sau:
- Tên mẹ: ${momName}
- Tuổi: ${momAge}
- Cân nặng & Chiều cao hiện tại: ${momWeightHeight}
- Ngày đầu kỳ kinh cuối: ${lmpDate} (sử dụng để ước tính tuổi thai)
- Tiền sử bệnh lý: ${momHistory || "Không có"}
- Lối sống: ${momLifestyle || "Không có"}
- Dị ứng: ${momAllergies || "Không có"}

Trình bày đầu ra dưới dạng một mục lục sạch sẽ, dễ đọc, sử dụng Markdown cho tiêu đề và danh sách.`;

                callGeminiAPI(prompt, handbookResultContainer);
            });

            document.getElementById('postpartum-handbook-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const babyName = document.getElementById('baby-name').value;
                const babyNickname = document.getElementById('baby-nickname').value;
                const babyDob = document.getElementById('baby-dob').value;
                const babyBirthWeight = document.getElementById('baby-birth-weight').value;
                const babyBirthOrder = document.getElementById('baby-birth-order').value;
                const babyDeliveryMethod = document.getElementById('baby-delivery-method').value;
                const babyVaccines = document.getElementById('baby-vaccines').value;
                const babyCareWishes = document.getElementById('baby-care-wishes').value;
                const momName = document.getElementById('mom-name-post').value;
                const momDob = document.getElementById('mom-dob-post').value;
                const momHealthStatus = document.getElementById('mom-health-status').value;
                const momMilkStatus = document.getElementById('mom-milk-status').value;
                const momFeedingPlan = document.getElementById('mom-feeding-plan').value;

                const prompt = `Bạn là "măm", một trợ lý AI thân thiện và chuyên nghiệp, chuyên tạo cẩm nang sau sinh cá nhân hóa cho một trang web Việt Nam. Phản hồi của bạn BẮT BUỘC phải bằng tiếng Việt.

Tạo một cẩm nang dưới dạng mục lục chi tiết. Tiêu đề chính của cẩm nang phải là: "Cẩm Nang Chăm Sóc Bé ${babyName} 6 Tháng Đầu".

Cẩm nang phải là một hướng dẫn toàn diện cho 6 tháng đầu sau sinh, cho cả mẹ và bé. Cấu trúc mục lục một cách logic, bao gồm các chủ đề theo tháng hoặc theo các lĩnh vực chính như:
- Cột mốc phát triển của bé (Tháng 1, Tháng 2, v.v.).
- Hướng dẫn cho ăn (dựa trên mong muốn của mẹ).
- Lịch trình ngủ.
- Chăm sóc bé cơ bản (tắm, thay tã).
- Hướng dẫn lịch tiêm chủng (dựa trên những gì đã được tiêm).
- Phục hồi sau sinh của mẹ (thể chất và cảm xúc).
- Hỗ trợ cho con bú (nếu cho con bú).
- Khi nào cần tham khảo ý kiến bác sĩ (cho mẹ và bé).

Cá nhân hóa lời khuyên dựa trên dữ liệu người dùng sau:
- Tên bé: ${babyName}, Tên ở nhà: ${babyNickname || "Không có"}
- Ngày sinh: ${babyDob}, Cân nặng lúc sinh: ${babyBirthWeight}, Con thứ: ${babyBirthOrder}, Hình thức sinh: ${babyDeliveryMethod}
- Tiêm chủng đã thực hiện: ${babyVaccines || "Chưa có"}
- Mong muốn chăm sóc bé: ${babyCareWishes || "Chăm sóc tiêu chuẩn"}
- Tên mẹ: ${momName}, Ngày sinh mẹ: ${momDob}
- Sức khỏe mẹ: ${momHealthStatus || "Bình thường"}
- Tình trạng sữa mẹ: ${momMilkStatus}
- Kế hoạch cho ăn: ${momFeedingPlan}

Trình bày đầu ra dưới dạng một mục lục sạch sẽ, dễ đọc, sử dụng Markdown cho tiêu đề và danh sách.`;

                callGeminiAPI(prompt, handbookResultContainer);
            });
            
            // --- 11. UNIVERSAL API CALLER ---
            const callGeminiAPI = (prompt, resultContainer) => {
                // ĐOẠN CODE ĐÚNG
if (GEMINI_API_KEY === "AIzaSyDTa9lu-HcrhdkiQXHa9-E0Glj_7f6rnRc") {
    const errorMsg = "Lỗi: Vui lòng thay thế 'YOUR_API_KEY_HERE' bằng Gemini API Key của bạn trong mã JavaScript.";
    if (resultContainer) { resultContainer.innerHTML = `<p style="color: red;">${errorMsg}</p>`; resultContainer.classList.remove('hidden'); }
    else { alert(errorMsg); }
    return;
}

                if(resultContainer) {
                    resultContainer.innerHTML = '<div class="loading-spinner"></div>';
                    resultContainer.classList.remove('hidden');
                }
                const thinkingMsg = resultContainer ? null : displayAIMessage('...', true);

                const apiURL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
                const requestBody = { "contents": [{ "parts": [{ "text": prompt }] }] };

                fetch(apiURL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) })
                    .then(response => {
                        if (!response.ok) { return response.json().then(errorData => { throw new Error(`API Error: ${response.status}. ${JSON.stringify(errorData)}`); }); }
                        return response.json();
                    })
                    .then(data => {
                        const responseText = data?.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (responseText) {
                            if (resultContainer) {
                                // Simple Markdown to HTML conversion
                                let html = responseText
                                    .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                                    .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                                    .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                                    .replace(/^\* (.*$)/gim, '<li>$1</li>')
                                    .replace(/\*\*(.*)\*\*/g, '<strong>$1</strong>')
                                    .replace(/\n/g, '<br>');
                                // Wrap lists
                                html = html.replace(/<br><li>/g, '<li>').replace(/(<li>.*<\/li>)/g, '<ul>$1</ul>');
                                html = html.replace(/<\/ul><br><ul>/g, '');

                                resultContainer.innerHTML = html;
                            } else if (thinkingMsg) {
                                thinkingMsg.textContent = responseText;
                            }
                        } else {
                            throw new Error("Invalid response format from API.");
                        }
                    })
                    .catch(error => {
                        console.error('Error calling Gemini API:', error);
                        const errorText = "Xin lỗi, tôi đang gặp sự cố khi kết nối với AI. Vui lòng thử lại sau.";
                         if (resultContainer) { resultContainer.innerHTML = `<p style="color: red;">${errorText}</p>`; }
                         else if (thinkingMsg) { thinkingMsg.textContent = errorText; }
                    });
            };

            // --- 12. INITIALIZE ---
            showPage('page1');
            updateCartBadges(); // Initial badge update on load
        });
    </script>
</body>
</html>
