<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>măm</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        /* --- GLOBAL STYLES & SETUP --- */
        :root {
            --primary-color: #e16232;
            --bg-color: #FFFBEA;
            --dark-text: #000000;
            --light-text: #f8f1d5;
            --green: #4f823d;
            --blue: #4a83b8;
            --yellow: #fae961;
        }

        body {
            background-color: var(--bg-color);
            font-family: 'Helvetica Neue', sans-serif;
            margin: 0;
            overflow-x: hidden;
            scroll-behavior: smooth;
        }

        .hidden {
            display: none !important;
        }
        
        /* --- LANGUAGE SELECTOR (SHARED) --- */
        .language-selector { background: rgba(255, 255, 255, 0.2); padding: 5px 10px; border-radius: 10px; }
        .lang-btn { color: var(--dark-text); text-decoration: none; font-weight: bold; margin: 0 5px; cursor: pointer; transition: color 0.3s; }
        .lang-btn.active { color: var(--primary-color); }

        /* --- PAGE 1: WELCOME --- */
        #page1 { display: flex; justify-content: center; align-items: center; height: 100vh; text-align: center; position: relative; overflow: hidden; }
        .welcome-container { animation: fadeIn 2s ease-in-out; z-index: 5; position: relative; }
        #page1 .language-selector { position: absolute; top: -70px; right: 0; }
        .logo-main { font-size: 15vw; color: var(--primary-color); font-weight: 900; }
        .slogan { color: var(--dark-text); font-size: 1.5rem; margin-top: -20px; font-weight: bold; height: 2.5em; }
        .slogan .cursor { display: inline-block; background-color: var(--dark-text); margin-left: 0.1rem; width: 3px; animation: blink 1s infinite; }
        @keyframes blink { 50% { background-color: transparent; } }
        .start-button { display: inline-block; margin-top: 40px; padding: 15px 45px; border: 3px solid var(--primary-color); border-radius: 50px; color: var(--primary-color); text-decoration: none; font-weight: bold; font-size: 1.2rem; transition: background-color 0.3s, color 0.3s; }
        .start-button:hover { background-color: var(--primary-color); color: var(--light-text); cursor: pointer; }
        .decorations { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        .decorations .shape { position: absolute; animation: float 25s infinite linear; list-style: none; }
        .decorations .circle { width: 30px; height: 30px; background-color: var(--green); border-radius: 50%; top: 10%; left: 15%; animation-duration: 22s; }
        .decorations .star { width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-bottom: 30px solid var(--blue); top: 80%; left: 10%; animation-delay: -5s; animation-duration: 28s; }
        .decorations .heart { position: relative; width: 30px; height: 27px; top: 50%; left: 90%; animation-delay: -10s; animation-duration: 19s; }
        .decorations .heart:before, .decorations .heart:after { content: ""; position: absolute; top: 0; width: 15px; height: 24px; background-color: var(--primary-color); border-radius: 15px 15px 0 0; }
        .decorations .heart:before { left: 15px; transform: rotate(-45deg); transform-origin: 0 100%; }
        .decorations .heart:after { left: 0; transform: rotate(45deg); transform-origin: 100% 100%; }
        .decorations .triangle { width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-bottom: 30px solid var(--yellow); top: 20%; left: 85%; animation-delay: -15s; animation-duration: 30s; }
        .decorations .circle.c2 { top: 75%; left: 80%; background-color: var(--yellow); animation-delay: -3s; animation-duration: 24s; }
        .decorations .triangle.t2 { top: 40%; left: 5%; border-bottom-color: var(--green); animation-delay: -8s; animation-duration: 20s; }
        @keyframes float { 0% { transform: translateY(0px) rotate(0deg); opacity: 0.7; } 50% { transform: translateY(-30px) rotate(180deg); opacity: 1; } 100% { transform: translateY(0px) rotate(360deg); opacity: 0.7; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- PAGE 2: HOME CAROUSEL --- */
        #page2 { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        .carousel-container { display: flex; align-items: center; justify-content: center; width: 100%; height: 300px; }
        .carousel { position: relative; width: 100%; height: 100%; }
        .carousel-item { position: absolute; width: 200px; height: 200px; border-radius: 50%; background-color: var(--primary-color); display: flex; justify-content: center; align-items: center; text-align: center; color: white; font-size: 1.2rem; font-weight: bold; padding: 10px; cursor: pointer; transition: transform 0.5s ease-out, opacity 0.5s ease-out; left: 50%; top: 50%; margin-left: -100px; margin-top: -100px; transform: scale(0); opacity: 0; }
        .carousel-item.active { transform: translateX(0) scale(1.5); opacity: 1; z-index: 10; overflow: hidden; }
        .carousel-item.prev { transform: translateX(-280px) scale(0.8); opacity: 0.5; z-index: 5; }
        .carousel-item.next { transform: translateX(280px) scale(0.8); opacity: 0.5; z-index: 5; }
        .discovery-follower { position: absolute; width: 100px; height: 100px; background-color: rgba(248, 241, 213, 0.8); border-radius: 50%; color: var(--primary-color); display: flex; justify-content: center; align-items: center; font-size: 1.1rem; font-weight: bold; opacity: 0; transform: translate(-50%, -50%) scale(0); transition: opacity 0.3s, transform 0.3s; pointer-events: none; z-index: 11; }
        .carousel-item.active:hover .discovery-follower { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        .carousel-nav { margin-top: 50px; }
        .carousel-nav button { background-color: var(--primary-color); border: none; color: white; padding: 10px 20px; font-size: 24px; cursor: pointer; margin: 0 25px; border-radius: 50%; width: 50px; height: 50px; transition: transform 0.2s; }
        .carousel-nav button:hover { transform: scale(1.1); }

        /* --- SHARED HEADER & FOOTER --- */
        .main-header { position: fixed; top: 0; width: 100%; background-color: rgba(255, 255, 255, 0.5); backdrop-filter: blur(5px); z-index: 1000; transition: top 0.4s ease-in-out; }
        .main-nav { display: flex; justify-content: space-between; align-items: center; padding: 10px 30px; }
        .nav-left, .nav-right { display: flex; align-items: center; gap: 15px; }
        .nav-item { color: #333; text-decoration: none; padding: 10px 15px; margin: 0; border-radius: 8px; font-weight: bold; transition: background-color 0.3s, color 0.3s; }
        .nav-item:hover { background-color: rgba(225, 98, 50, 0.2); }
        .nav-item.active { background-color: var(--primary-color); color: var(--light-text); }
        .nav-logo { color: var(--primary-color); font-weight: 900; font-size: 28px; text-decoration: none; margin-right: 15px; }
        
        /* NEW: User Profile Styles */
        .user-profile { display: flex; align-items: center; gap: 12px; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-color); }
        .user-name { font-weight: bold; color: #333; }
        #logout-btn { color: #333; font-weight: bold; cursor: pointer; padding: 10px 15px; border-radius: 8px; transition: background-color 0.3s; }
        #logout-btn:hover { background-color: rgba(0,0,0,0.1); }

        .contact-footer { background-color: var(--dark-text); color: var(--light-text); padding: 40px 10%; text-align: center; }
        .contact-footer h3 { font-size: 1.5rem; color: var(--primary-color); margin-bottom: 20px; }
        .contact-info { display: flex; justify-content: center; align-items: center; gap: 30px; flex-wrap: wrap; }
        .contact-info a, .contact-info span { color: var(--light-text); text-decoration: none; font-size: 1.1rem; }
        .contact-info svg { width: 30px; height: 30px; fill: var(--light-text); transition: fill 0.3s; }
        .contact-info a:hover svg { fill: var(--primary-color); }

        /* --- CONTENT PAGES --- */
        .page-content { padding-top: 100px; padding-bottom: 100px; min-height: 70vh; }
        .content-container { padding: 20px 5%; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .page-header h1 { color: var(--primary-color); }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 30px; }
        .item-box { background-color: white; border: 1px solid #ddd; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.05); display: flex; flex-direction: column; transition: transform 0.2s, box-shadow 0.2s; }
        .item-box:hover { transform: translateY(-5px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
        .item-image { width: 100%; height: 250px; background-size: cover; background-position: center; }
        .item-info { padding: 15px; text-align: left; flex-grow: 1; display: flex; flex-direction: column; }
        .item-name { font-size: 1.2rem; margin: 0 0 10px 0; color: #333; }
        .item-price { font-size: 1.1rem; color: var(--primary-color); font-weight: bold; margin-bottom: 15px; }
        .item-details { font-size: 0.9rem; color: #666; margin-bottom: 15px; }
        .item-details span { display: block; margin-bottom: 5px; }
        .contact-owner-btn { width: 100%; padding: 12px; border: none; background-color: var(--primary-color); color: var(--light-text); border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: auto; transition: background-color 0.3s; }
        .contact-owner-btn:hover { opacity: 0.9; }

        /* --- Floating Action Button --- */
        .post-item-btn { position: fixed; bottom: 40px; right: 40px; width: 70px; height: 70px; background-color: var(--primary-color); color: var(--light-text); border: none; border-radius: 35px; font-size: 28px; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer; z-index: 1001; transition: transform 0.2s; }
        .post-item-btn:hover { transform: scale(1.1); }

        /* --- LOGIN & REGISTER PAGE STYLES --- */
        #page8 { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 40px 20px; }
        .form-wrapper { background-color: #fff; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 450px; text-align: center; position: relative; }
        .close-form-btn { position: absolute; top: 15px; right: 20px; font-size: 2rem; color: #aaa; cursor: pointer; transition: color 0.3s; text-decoration: none; }
        .close-form-btn:hover { color: var(--dark-text); }
        .form-toggle { display: flex; justify-content: center; margin-bottom: 30px; border: 1px solid #ddd; border-radius: 30px; overflow: hidden; }
        .form-toggle button { flex: 1; padding: 15px; border: none; background-color: transparent; font-weight: bold; font-size: 1rem; cursor: pointer; transition: all 0.3s; color: #333; }
        .form-toggle button.active { background-color: var(--primary-color); color: var(--light-text); }
        .form-wrapper h2 { color: var(--primary-color); margin-bottom: 20px; }
        .social-login .social-btn { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border:none; text-decoration: none; font-weight: bold; color: #fff; display: flex; align-items: center; justify-content: center; gap: 10px; transition: opacity 0.3s; cursor: pointer; font-size: 1rem; }
        .social-login .social-btn:hover { opacity: 0.9; }
        .social-btn i { font-size: 1.2rem; }
        .social-btn.facebook { background-color: #3b5998; }
        .social-btn.google { background-color: #db4437; }
        .divider { display: flex; align-items: center; text-align: center; margin: 25px 0; color: #aaa; }
        .divider::before, .divider::after { content: ''; flex: 1; border-bottom: 1px solid #ddd; }
        .divider p { margin: 0 15px; font-weight: bold; }
        .form-wrapper form input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .submit-btn { width: 100%; padding: 15px; border: none; background-color: var(--primary-color); color: var(--light-text); border-radius: 8px; font-weight: bold; font-size: 1.1rem; cursor: pointer; transition: opacity 0.3s; }
        .submit-btn:hover { opacity: 0.9; }
        
        /* --- MODAL STYLES --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 3000; display: flex; justify-content: center; align-items: center; padding: 20px; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); width: 100%; max-width: 600px; position: relative; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; color: var(--primary-color); }
        .modal-close-btn { font-size: 2.5rem; line-height: 1; color: #aaa; cursor: pointer; background: none; border: none; }
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 5px; color: #333; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-family: inherit; font-size: 1rem; }
    </style>
</head>
<body>

    <!-- ======== Pages: Welcome, Carousel, About, etc. (Mostly unchanged) ======== -->
    <div id="page1">
        <!-- Welcome Content -->
        <div class="welcome-container">
            <div class="logo-main">măm</div>
            <p class="slogan"></p>
            <a id="startButton" class="start-button">Bắt đầu</a>
        </div>
        <div class="decorations"> <div class="shape circle"></div><div class="shape star"></div><div class="shape heart"></div><div class="shape triangle"></div><div class="shape circle c2"></div><div class="shape triangle t2"></div> </div>
    </div>
    <div id="page2" class="hidden">
        <!-- Carousel Content -->
        <div class="carousel-container">
            <div class="carousel">
                <div class="carousel-item" data-target="page3"><div class="circle-content">Về chúng tôi</div><div class="discovery-follower">khám phá</div></div>
                <div class="carousel-item" data-target="page4"><div class="circle-content">Kết nối sữa mẹ</div><div class="discovery-follower">khám phá</div></div>
                <div class="carousel-item" data-target="page5"><div class="circle-content">Thuê - Pass đồ</div><div class="discovery-follower">khám phá</div></div>
                <div class="carousel-item" data-target="page6"><div class="circle-content">Cẩm nang</div><div class="discovery-follower">khám phá</div></div>
            </div>
        </div>
        <div class="carousel-nav"><button id="prevBtn"><</button><button id="nextBtn">></button></div>
    </div>
    <div id="page3" class="page-content hidden"> <!-- About Us page --> </div>
    
    <!-- ======== Header (MODIFIED) ======== -->
    <header id="mainHeader" class="main-header hidden">
        <nav class="main-nav">
            <div class="nav-left">
                <a href="#" class="nav-logo" data-target="page1">măm</a>
                <a href="#" class="nav-item" data-target="page3">Về chúng tôi</a>
                <a href="#" class="nav-item" data-target="page4">Kết nối sữa mẹ</a>
                <a href="#" class="nav-item" data-target="page5">Thuê - Pass đồ</a>
                <a href="#" class="nav-item" data-target="page6">Cẩm nang</a>
            </div>
            <div class="nav-right">
                <!-- This container holds Login/Register buttons -->
                <div id="auth-links">
                    <a href="#" class="nav-item" data-target="page8" data-action="show-login">Đăng nhập</a>
                    <a href="#" class="nav-item" data-target="page8" data-action="show-register">Đăng ký</a>
                </div>
                <!-- NEW: This container holds the user profile when logged in -->
                <div id="user-profile" class="user-profile hidden">
                    <img id="user-avatar" src="" alt="Avatar" class="user-avatar">
                    <span id="user-name" class="user-name"></span>
                    <a id="logout-btn">Đăng xuất</a>
                </div>
            </div>
        </nav>
    </header>

    <!-- ======== PAGE 4: Breast Milk Connection (NEW & DYNAMIC) ======== -->
    <div id="page4" class="page-content hidden">
        <div class="content-container">
            <div class="page-header">
                <h1>Kết nối sữa mẹ</h1>
            </div>
            <div id="milk-post-grid" class="grid-container">
                <!-- Milk posts will be dynamically inserted here by JavaScript -->
            </div>
        </div>
    </div>

    <!-- ======== PAGE 5: Rent/Pass Items (MODIFIED) ======== -->
    <div id="page5" class="page-content hidden">
        <div class="content-container">
            <div class="page-header">
                <h1>Thuê - Pass đồ</h1>
            </div>
            <div id="product-grid" class="grid-container">
                <!-- Products will be dynamically inserted here by JavaScript -->
            </div>
        </div>
    </div>

    <div id="page6" class="page-content hidden"> <!-- Handbook page --> </div>

    <!-- ======== PAGE 8: Login/Register Forms ======== -->
    <div id="page8" class="page-content hidden">
        <div class="form-wrapper">
            <a href="#" id="close-login-page-btn" class="close-form-btn" title="Go Back">×</a>
            <div class="form-toggle">
                <button id="show-login-btn" class="active">Đăng nhập</button>
                <button id="show-register-btn">Đăng ký</button>
            </div>
            <!-- Login Form -->
            <div id="login-form-container">
                <h2>Đăng nhập vào tài khoản</h2>
                <div class="social-login">
                    <button id="google-login-btn" class="social-btn google"><i class="fab fa-google"></i> Đăng nhập với Google</button>
                    <button id="facebook-login-btn" class="social-btn facebook"><i class="fab fa-facebook-f"></i> Đăng nhập với Facebook</button>
                </div>
                <div class="divider"><p>HOẶC</p></div>
                <form id="login-form">
                    <input type="email" name="email" placeholder="Email" required>
                    <input type="password" name="password" placeholder="Mật khẩu" required>
                    <button type="submit" class="submit-btn">Đăng nhập</button>
                </form>
            </div>
            <!-- Register Form -->
            <div id="register-form-container" class="hidden">
                 <h2>Tạo tài khoản mới</h2>
                <div class="social-login">
                    <button id="google-register-btn" class="social-btn google"><i class="fab fa-google"></i> Đăng ký với Google</button>
                    <button id="facebook-register-btn" class="social-btn facebook"><i class="fab fa-facebook-f"></i> Đăng ký với Facebook</button>
                </div>
                <div class="divider"><p>HOẶC</p></div>
                <form id="register-form">
                    <input type="email" name="email" placeholder="Địa chỉ Email" required>
                    <input type="password" name="password" placeholder="Tạo mật khẩu" required>
                    <button type="submit" class="submit-btn">Đăng ký</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- ======== MODALS & FLOATING BUTTON ======== -->
    
    <!-- Floating "+" Button -->
    <button id="post-item-btn" class="post-item-btn hidden" aria-label="Đăng tin mới"> 
        <i class="fas fa-plus"></i> 
    </button>

    <!-- Modal for Adding Products -->
    <div id="add-item-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Thêm sản phẩm cho thuê/pass</h2>
                <button class="modal-close-btn">×</button>
            </div>
            <form id="add-item-form">
                <div class="form-group"><label for="itemName">Tên sản phẩm</label><input type="text" name="itemName" required></div>
                <div class="form-group"><label for="itemBrand">Thương hiệu</label><input type="text" name="itemBrand"></div>
                <div class="form-group"><label for="itemCondition">Tình trạng</label><select name="itemCondition" required><option value="New">Mới</option><option value="Like New">Đã dùng - Như mới</option><option value="Good">Đã dùng - Tốt</option><option value="Fair">Đã dùng - Khá</option></select></div>
                <div class="form-group"><label for="salePrice">Giá bán (VNĐ)</label><input type="number" name="salePrice" placeholder="Để trống nếu chỉ cho tặng"></div>
                <div class="form-group"><label for="itemDescription">Mô tả</label><textarea name="itemDescription" rows="3" required></textarea></div>
                <div class="form-group"><label for="itemImage">Hình ảnh</label><input type="file" name="itemImage" accept="image/*" required></div>
                <button type="submit" class="submit-btn">Đăng sản phẩm</button>
            </form>
        </div>
    </div>

    <!-- NEW: Modal for Adding Milk Posts -->
    <div id="add-milk-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Đăng tin kết nối sữa mẹ</h2>
                <button class="modal-close-btn">×</button>
            </div>
            <form id="add-milk-form">
                <div class="form-group"><label for="milkTitle">Tiêu đề (ví dụ: "Tặng sữa mẹ trữ đông cho bé")</label><input type="text" name="milkTitle" required></div>
                <div class="form-group"><label for="milkRegion">Khu vực (Tỉnh/Thành phố)</label><input type="text" name="milkRegion" placeholder="ví dụ: TP. Hồ Chí Minh" required></div>
                <div class="form-group"><label for="storageDate">Ngày trữ đông</label><input type="date" name="storageDate" required></div>
                <div class="form-group"><label for="milkNotes">Ghi chú thêm</label><textarea name="milkNotes" rows="3" placeholder="ví dụ: Sữa mẹ vắt hàng ngày, trữ đông đúng quy trình, mẹ không dùng thuốc..."></textarea></div>
                <div class="form-group"><label for="milkImage">Hình ảnh (nếu có)</label><input type="file" name="milkImage" accept="image/*"></div>
                <button type="submit" class="submit-btn">Đăng tin</button>
            </form>
        </div>
    </div>


    <!-- ========================== JAVASCRIPT SECTION ======================== -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>

    <script>
        const firebaseConfig = {
  apiKey: "AIzaSyDTa9lu-HcrhdkiQXHa9-E0Glj_7f6rnRc",
  authDomain: "mam-2-c06f4.firebaseapp.com",
  projectId: "mam-2-c06f4",
  // === SỬA LẠI DÒNG NÀY ===
  storageBucket: "mam-2-c06f4.firebasestorage.app", 
  // ==========================
  messagingSenderId: "494501201303",
  appId: "1:494501201303:web:f32f75d93042964ae5f0d2",
  measurementId: "G-56FZ0TK2FP"
};
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        const googleProvider = new firebase.auth.GoogleAuthProvider();
        const facebookProvider = new firebase.auth.FacebookAuthProvider();

        document.addEventListener('DOMContentLoaded', function() {
            // --- UI Elements ---
            const pages = document.querySelectorAll('body > div[id^="page"]');
            const mainHeader = document.getElementById('mainHeader');
            const navLinks = document.querySelectorAll('.nav-item, .nav-logo');
            let lastPageId = 'page1';
            
            // Auth UI
            const authLinks = document.getElementById('auth-links');
            const userProfile = document.getElementById('user-profile');
            const userAvatar = document.getElementById('user-avatar');
            const userName = document.getElementById('user-name');
            const logoutBtn = document.getElementById('logout-btn');

            // Floating Button & Modals
            const postItemBtn = document.getElementById('post-item-btn');
            const addItemModal = document.getElementById('add-item-modal');
            const addMilkModal = document.getElementById('add-milk-modal');
            const addItemForm = document.getElementById('add-item-form');
            const addMilkForm = document.getElementById('add-milk-form');

            // --- Page Navigation ---
            function showPage(pageId) {
                if (pageId !== 'page8') lastPageId = document.querySelector('body > div[id^="page"]:not(.hidden)')?.id || 'page1';
                
                pages.forEach(page => page.classList.add('hidden'));
                const targetPage = document.getElementById(pageId);
                if (targetPage) targetPage.classList.remove('hidden');

                mainHeader.classList.toggle('hidden', ['page1', 'page2', 'page8'].includes(pageId));
                navLinks.forEach(link => link.classList.toggle('active', link.dataset.target === pageId));
                window.scrollTo(0, 0);

                // Manage floating button visibility and function
                const isLoggedIn = auth.currentUser;
                const onContentPage = ['page4', 'page5'].includes(pageId);
                postItemBtn.classList.toggle('hidden', !isLoggedIn || !onContentPage);

                if (isLoggedIn && onContentPage) {
                    postItemBtn.dataset.modalTarget = (pageId === 'page4') ? 'add-milk-modal' : 'add-item-modal';
                }

                if (pageId === 'page4') displayMilkPosts();
                if (pageId === 'page5') displayProducts();
            }

            document.getElementById('startButton').addEventListener('click', () => showPage('page2'));
            document.querySelectorAll('[data-target]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    showPage(link.dataset.target);
                    // Handle login/register actions from header
                    if (link.dataset.action === 'show-login') document.getElementById('show-login-btn').click();
                    if (link.dataset.action === 'show-register') document.getElementById('show-register-btn').click();
                });
            });
            document.getElementById('close-login-page-btn').addEventListener('click', (e) => { e.preventDefault(); showPage(lastPageId); });

            // Carousel Logic
            const items = document.querySelectorAll('.carousel-item');
            let currentIndex = 0;
            function updateCarousel() {
                if(items.length === 0) return;
                items.forEach((item, index) => {
                    item.classList.remove('active', 'prev', 'next');
                    if (index === currentIndex) item.classList.add('active');
                    else if (index === (currentIndex - 1 + items.length) % items.length) item.classList.add('prev');
                    else if (index === (currentIndex + 1) % items.length) item.classList.add('next');
                });
            }
            document.getElementById('nextBtn')?.addEventListener('click', () => { currentIndex = (currentIndex + 1) % items.length; updateCarousel(); });
            document.getElementById('prevBtn')?.addEventListener('click', () => { currentIndex = (currentIndex - 1 + items.length) % items.length; updateCarousel(); });
            new MutationObserver((mutations) => { if(!mutations[0].target.classList.contains('hidden')){ currentIndex=0; updateCarousel(); } }).observe(document.getElementById('page2'), { attributes: true });


            // --- Authentication Logic ---
            auth.onAuthStateChanged(user => {
                if (user) {
                    // User is signed in
                    authLinks.classList.add('hidden');
                    userProfile.classList.remove('hidden');
                    userName.textContent = user.displayName || user.email.split('@')[0];
                    userAvatar.src = user.photoURL || 'https://via.placeholder.com/40'; // Default avatar
                    showPage(lastPageId === 'page1' ? 'page2' : lastPageId);
                } else {
                    // User is signed out
                    authLinks.classList.remove('hidden');
                    userProfile.classList.add('hidden');
                    postItemBtn.classList.add('hidden');
                }
                // Refresh content on current page to reflect login status
                const currentPage = document.querySelector('body > div[id^="page"]:not(.hidden)');
                if (currentPage) showPage(currentPage.id);
            });
            
            logoutBtn.addEventListener('click', () => auth.signOut().then(() => showPage('page1')));

            const socialLogin = provider => {
                auth.signInWithPopup(provider).catch(error => alert(`Đăng nhập thất bại: ${error.message}`));
            };
            document.getElementById('google-login-btn').addEventListener('click', () => socialLogin(googleProvider));
            document.getElementById('facebook-login-btn').addEventListener('click', () => socialLogin(facebookProvider));
            document.getElementById('google-register-btn').addEventListener('click', () => socialLogin(googleProvider));
            document.getElementById('facebook-register-btn').addEventListener('click', () => socialLogin(facebookProvider));
            
            // Login/Register with Email
            document.getElementById('login-form').addEventListener('submit', e => { e.preventDefault(); auth.signInWithEmailAndPassword(e.target.email.value, e.target.password.value).catch(err => alert(err.message)); });
            document.getElementById('register-form').addEventListener('submit', e => { e.preventDefault(); auth.createUserWithEmailAndPassword(e.target.email.value, e.target.password.value).catch(err => alert(err.message)); });
            
            // Login/Register tab switching
            const loginContainer = document.getElementById('login-form-container');
            const registerContainer = document.getElementById('register-form-container');
            const showLoginBtn = document.getElementById('show-login-btn');
            const showRegisterBtn = document.getElementById('show-register-btn');
            showLoginBtn.addEventListener('click', () => { loginContainer.classList.remove('hidden'); registerContainer.classList.add('hidden'); showLoginBtn.classList.add('active'); showRegisterBtn.classList.remove('active'); });
            showRegisterBtn.addEventListener('click', () => { loginContainer.classList.add('hidden'); registerContainer.classList.remove('hidden'); showLoginBtn.classList.remove('active'); showRegisterBtn.classList.add('active'); });


            // --- Real-time Data Display ---
            function displayProducts() {
                const grid = document.getElementById('product-grid');
                db.collection('products').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                    if (snapshot.empty) {
                        grid.innerHTML = '<p>Chưa có sản phẩm nào. Hãy là người đầu tiên đăng bán!</p>';
                        return;
                    }
                    grid.innerHTML = '';
                    snapshot.forEach(doc => {
                        const product = doc.data();
                        const price = product.salePrice ? `${Number(product.salePrice).toLocaleString('vi-VN')} VNĐ` : 'Cho tặng';
                        grid.innerHTML += `
                            <div class="item-box">
                                <div class="item-image" style="background-image: url('${product.imageUrl}');"></div>
                                <div class="item-info">
                                    <h3 class="item-name">${product.name}</h3>
                                    <p class="item-price">${price}</p>
                                    <div class="item-details">
                                        <span><strong>Thương hiệu:</strong> ${product.brand || 'N/A'}</span>
                                        <span><strong>Tình trạng:</strong> ${product.condition}</span>
                                    </div>
                                    <button class="contact-owner-btn" onclick="alert('Liên hệ: ${product.ownerEmail}')">Liên hệ người bán</button>
                                </div>
                            </div>`;
                    });
                }, error => console.error("Error fetching products:", error));
            }

            function displayMilkPosts() {
                const grid = document.getElementById('milk-post-grid');
                db.collection('milk_posts').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                    if (snapshot.empty) {
                        grid.innerHTML = '<p>Chưa có tin đăng nào. Hãy là người đầu tiên kết nối!</p>';
                        return;
                    }
                    grid.innerHTML = '';
                    snapshot.forEach(doc => {
                        const post = doc.data();
                        const imageUrl = post.imageUrl || 'https://via.placeholder.com/300x250?text=Sữa+mẹ';
                        grid.innerHTML += `
                            <div class="item-box">
                                <div class="item-image" style="background-image: url('${imageUrl}');"></div>
                                <div class="item-info">
                                    <h3 class="item-name">${post.title}</h3>
                                    <div class="item-details">
                                        <span><strong>Khu vực:</strong> ${post.region}</span>
                                        <span><strong>Ngày trữ:</strong> ${post.storageDate}</span>
                                        <span><strong>Ghi chú:</strong> ${post.notes || 'Không có'}</span>
                                    </div>
                                    <button class="contact-owner-btn" onclick="alert('Liên hệ: ${post.ownerEmail}')">Liên hệ</button>
                                </div>
                            </div>`;
                    });
                }, error => console.error("Error fetching milk posts:", error));
            }

            // --- Modals and Forms Logic ---
            postItemBtn.addEventListener('click', () => {
                const modalId = postItemBtn.dataset.modalTarget;
                document.getElementById(modalId)?.classList.add('visible');
            });

            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal-overlay') || e.target.classList.contains('modal-close-btn')) {
                        modal.classList.remove('visible');
                    }
                });
            });

            const handleFormSubmit = async (form, collectionName, fileInputName) => {
                const user = auth.currentUser;
                if (!user) return alert('Bạn cần đăng nhập để đăng tin!');

                const submitButton = form.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.textContent = 'Đang xử lý...';

                try {
                    const file = form.querySelector(`input[name="${fileInputName}"]`).files[0];
                    let downloadURL = null;
                    if (file) {
                        const filePath = `${collectionName}/${user.uid}/${Date.now()}_${file.name}`;
                        const snapshot = await storage.ref(filePath).put(file);
                        downloadURL = await snapshot.ref.getDownloadURL();
                    }

                    const formData = new FormData(form);
                    const data = {
                        ownerId: user.uid,
                        ownerEmail: user.email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    for (let [key, value] of formData.entries()) {
                       if (key !== fileInputName) data[key] = value;
                    }
                    if (downloadURL) data.imageUrl = downloadURL;

                    await db.collection(collectionName).add(data);
                    alert('Đăng tin thành công!');
                    form.reset();
                    form.closest('.modal-overlay').classList.remove('visible');
                } catch (error) {
                    console.error("Submit error:", error);
                    alert(`Đã xảy ra lỗi: ${error.message}`);
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Đăng tin';
                }
            };
            
            addItemForm.addEventListener('submit', e => { e.preventDefault(); handleFormSubmit(addItemForm, 'products', 'itemImage'); });
            addMilkForm.addEventListener('submit', e => { e.preventDefault(); handleFormSubmit(addMilkForm, 'milk_posts', 'milkImage'); });


            // --- Initial Load ---
            showPage('page1');
        });
    </script>
</body>
</html>
